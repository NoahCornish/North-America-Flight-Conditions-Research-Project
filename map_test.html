<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NAFCRP ‚Äî Live Flight Conditions Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b2540" />
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse for CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --ink:#0b2540; --muted:#62748a; --brand:#1a73e8;
    --vfr:#2ecc71; --mvfr:#3498db; --ifr:#e74c3c; --lifr:#8e44ad;
    --shadow:0 10px 26px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky; top:0; z-index:1000; background:linear-gradient(135deg,#0b2540,var(--brand)); color:#fff; box-shadow:var(--shadow);}
  .wrap{max-width:1200px;margin:0 auto;padding:.8rem 1rem;display:flex;gap:.8rem;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:.8rem;align-items:center}
  .logo{width:40px;height:40px;border-radius:12px;background:#fff1;border:1px solid #ffffff33;display:grid;place-items:center;font-weight:800}
  .title h1{margin:0;font-size:1.05rem;font-weight:800}
  .title p{margin:.25rem 0 0;opacity:.92;font-weight:600;font-size:.86rem}
  #map{height:calc(100vh - 78px); width:100%}
  .legend{position:absolute; right:12px; bottom:12px; z-index:1100; background:var(--card); border-radius:14px; padding:.6rem .8rem; box-shadow:var(--shadow)}
  .legend .row{display:flex;align-items:center;gap:.45rem;margin:.2rem 0}
  .dot{width:12px;height:12px;border-radius:50%}
  .dot.vfr{background:var(--vfr)} .dot.mvfr{background:var(--mvfr)} .dot.ifr{background:var(--ifr)} .dot.lifr{background:var(--lifr)}
  .meta{position:absolute; left:12px; bottom:12px; z-index:1100; font-size:.8rem; color:var(--muted); background:#ffffffcc; padding:.35rem .55rem; border-radius:10px}
  .badge{display:inline-block; padding:.1rem .45rem; border-radius:999px; color:#fff; font-weight:800; font-size:.75rem}
  .cat-VFR{background:var(--vfr)} .cat-MVFR{background:var(--mvfr)} .cat-IFR{background:var(--ifr)} .cat-LIFR{background:var(--lifr)}
  .leaflet-popup-content{margin:8px 10px; font-size:.92rem}
  .leaflet-popup-content h4{margin:.1rem 0 .35rem; font-size:1rem}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">üó∫Ô∏è</div>
      <div class="title">
        <h1>NAFCRP ‚Äî Live Flight Conditions Map</h1>
        <p>VFR / MVFR / IFR / LIFR ‚Ä¢ Canada & United States</p>
      </div>
    </div>
    <div id="lastUpdated">Loading‚Ä¶</div>
  </div>
</header>

<div id="map"></div>

<div class="legend">
  <h3>Condition</h3>
  <div class="row"><span class="dot vfr"></span> VFR</div>
  <div class="row"><span class="dot mvfr"></span> MVFR</div>
  <div class="row"><span class="dot ifr"></span> IFR</div>
  <div class="row"><span class="dot lifr"></span> LIFR</div>
</div>
<div class="meta">Source: clean_metars.csv + OurAirports ‚Ä¢ Project: NAFCRP</div>

<script>
/* ---- URLs ---- */
const CLEAN_METARS_URL = "https://raw.githubusercontent.com/NoahCornish/North-America-Flight-Conditions-Research-Project/refs/heads/main/Data/METARs/clean_metars.csv";
const OUR_AIRPORTS_CSV = "https://ourairports.com/data/airports.csv";

/* ---- Map ---- */
const map = L.map('map', { zoomControl: true, preferCanvas: true });
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18, attribution: '&copy; OpenStreetMap'
}).addTo(map);
map.setView([48.5, -98], 4);

const CAT_COLORS = { VFR:'#2ecc71', MVFR:'#3498db', IFR:'#e74c3c', LIFR:'#8e44ad' };
const catColor = (c) => CAT_COLORS[(c||'').toUpperCase()] || '#999';
function chip(cat){ return `<span class="badge cat-${cat}">${cat||'‚Äî'}</span>`; }

/* ---- Load Data ---- */
async function loadData(){
  const [metarRes, airportRes] = await Promise.all([
    fetch(CLEAN_METARS_URL).then(r=>r.text()),
    fetch(OUR_AIRPORTS_CSV).then(r=>r.text())
  ]);

  const metars = Papa.parse(metarRes, {header:true,dynamicTyping:false}).data;
  const airports = Papa.parse(airportRes, {header:true,dynamicTyping:false}).data;

  // Build lookup of ICAO ‚Üí coords + name
  const airportLookup = {};
  airports.forEach(r=>{
    if(r.ident && r.latitude_deg && r.longitude_deg){
      airportLookup[r.ident] = {
        lat: parseFloat(r.latitude_deg),
        lon: parseFloat(r.longitude_deg),
        name: r.name||""
      };
    }
  });

  // Use most recent flight_category per ICAO
  const latest = {};
  metars.forEach(r=>{
    if(!r.icao || !r.observed_utc) return;
    const ts=new Date(r.observed_utc);
    if(!latest[r.icao] || ts > latest[r.icao].ts){
      latest[r.icao] = {cat:r.flight_category, ts, raw:r.raw_text};
    }
  });

  const bounds=[];
  Object.keys(latest).forEach(icao=>{
    const info = latest[icao];
    const ap   = airportLookup[icao];
    if(!ap) return; // skip if no coords
    const marker=L.circleMarker([ap.lat,ap.lon],{
      radius:7,color:catColor(info.cat),fillColor:catColor(info.cat),fillOpacity:0.85
    });
    marker.bindPopup(`<h4>${icao} ‚Äî ${ap.name} ${chip(info.cat)}</h4><div>${info.raw||''}</div>`);
    marker.addTo(map);
    bounds.push([ap.lat,ap.lon]);
  });

  if(bounds.length) map.fitBounds(bounds);
  document.getElementById("lastUpdated").innerText="Updated " + new Date().toLocaleString();
}

document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NAFCRP ‚Äî Live Flight Conditions Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b2540" />
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --ink:#0b2540; --muted:#62748a; --brand:#1a73e8;
    --vfr:#2ecc71; --mvfr:#3498db; --ifr:#e74c3c; --lifr:#8e44ad;
    --shadow:0 10px 26px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky; top:0; z-index:1000; background:linear-gradient(135deg,#0b2540,var(--brand)); color:#fff; box-shadow:var(--shadow)}
  .wrap{max-width:1200px;margin:0 auto;padding:.8rem 1rem;display:flex;gap:.8rem;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:.8rem;align-items:center}
  .logo{width:40px;height:40px;border-radius:12px;background:#fff1;border:1px solid #ffffff33;display:grid;place-items:center;font-weight:800}
  .title h1{margin:0;font-size:1.05rem;font-weight:800;letter-spacing:.2px}
  .title p{margin:.25rem 0 0;opacity:.92;font-weight:600;font-size:.86rem}
  #map{height:calc(100vh - 78px); width:100%}
  .legend{position:absolute; right:12px; bottom:12px; z-index:1100; background:var(--card); border-radius:14px; padding:.6rem .8rem; box-shadow:var(--shadow)}
  .legend h3{margin:0 0 .35rem; font-size:.9rem}
  .legend .row{display:flex;align-items:center;gap:.45rem;margin:.2rem 0}
  .dot{width:12px;height:12px;border-radius:50%}
  .dot.vfr{background:var(--vfr)} .dot.mvfr{background:var(--mvfr)} .dot.ifr{background:var(--ifr)} .dot.lifr{background:var(--lifr)}
  .meta{position:absolute; left:12px; bottom:12px; z-index:1100; font-size:.8rem; color:var(--muted); background:#ffffffcc; padding:.35rem .55rem; border-radius:10px}
  .badge{display:inline-block; padding:.1rem .45rem; border-radius:999px; color:#fff; font-weight:800; font-size:.75rem; letter-spacing:.3px}
  .cat-VFR{background:var(--vfr)} .cat-MVFR{background:var(--mvfr)} .cat-IFR{background:var(--ifr)} .cat-LIFR{background:var(--lifr)}
  .leaflet-popup-content{margin:8px 10px; font-size:.92rem}
  .leaflet-popup-content h4{margin:.1rem 0 .35rem; font-size:1rem}
  .kv{display:grid;grid-template-columns:repeat(2,minmax(0,1fr)); gap:.3rem .8rem; margin-top:.35rem; font-size:.9rem}
  .k{color:#6b7b8c; font-weight:700}
  @media (max-width:640px){.title p{display:none} #map{height:calc(100vh - 66px)}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">üó∫Ô∏è</div>
      <div class="title">
        <h1>NAFCRP ‚Äî Live Flight Conditions Map</h1>
        <p>VFR / MVFR / IFR / LIFR ‚Ä¢ Canada & United States</p>
      </div>
    </div>
    <div id="lastUpdated" aria-live="polite">Loading‚Ä¶</div>
  </div>
</header>

<div id="map" role="region" aria-label="Flight conditions map"></div>
<div class="legend"><h3>Condition</h3>
  <div class="row"><span class="dot vfr"></span> VFR</div>
  <div class="row"><span class="dot mvfr"></span> MVFR</div>
  <div class="row"><span class="dot ifr"></span> IFR</div>
  <div class="row"><span class="dot lifr"></span> LIFR</div>
</div>
<div class="meta">Source: AviationWeather.gov ‚Ä¢ Project: NAFCRP</div>

<script>
const STATIONS = [/* your 200 ICAOs here, same as before */];
const API_BASE = "https://aviationweather.gov/api/data/metar?format=geojson&ids=";
const CHUNK_SIZE = 40;

const CAT_COLORS = { VFR:'#2ecc71', MVFR:'#3498db', IFR:'#e74c3c', LIFR:'#8e44ad' };
const catColor = (c) => CAT_COLORS[(c||'').toUpperCase()] || '#999';
function chip(cat){const c=(cat||'').toUpperCase();return `<span class="badge cat-${c}">${c||'‚Äî'}</span>`;}
function toLocal(iso){if(!iso) return '‚Äî';const s=/[zZ]$/.test(iso)?iso:iso+'Z';return new Date(s).toLocaleString();}

const map = L.map('map').setView([48.5,-98],4);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap'}).addTo(map);

function chunk(arr,n){const out=[];for(let i=0;i<arr.length;i+=n) out.push(arr.slice(i,i+n));return out;}
async function fetchChunk(ids){const url=API_BASE+encodeURIComponent(ids.join(','))+'&_='+Date.now();const r=await fetch(url);return r.json();}
function getProp(p,keys){for(const k of keys){if(p[k]!=null&&p[k]!=='') return p[k];}return undefined;}

function featureToMarker(f){
  const g=f.geometry||{}, p=f.properties||{}, coords=g.coordinates; if(!coords) return;
  const lat=coords[1], lon=coords[0];
  const icao=getProp(p,['station','icao','id'])||'‚Äî';
  const site=getProp(p,['name','site','stationName'])||'';
  const cat=(getProp(p,['flight_category','fltcat','category'])||'').toUpperCase();
  const obs=getProp(p,['obsTime','observation_time','observed','observed_utc']);
  const temp=getProp(p,['temp','temp_c']), dewp=getProp(p,['dewp','dewpoint_c']);
  const wdir=getProp(p,['wdir','wind_dir_deg']), wspd=getProp(p,['wspd','wind_kts']);
  const gust=getProp(p,['wgst','gust_kts']), vis=getProp(p,['visib','vis_sm']);
  const alt=getProp(p,['altim','altimeter_hpa']); const raw=getProp(p,['rawOb','raw_text','raw'])||'';

  const m=L.circleMarker([lat,lon],{radius:7,weight:1.5,color:catColor(cat),fillColor:catColor(cat),fillOpacity:.85}).addTo(map);
  const name=site?`${icao} ‚Äî ${site}`:icao;
  const html=`<h4>${name} ${chip(cat)}</h4>
  <div class="kv"><div><div class="k">Observed</div>${toLocal(obs)}</div>
  <div><div class="k">Visibility</div>${vis?vis+' sm':'‚Äî'}</div>
  <div><div class="k">Temp</div>${temp?temp+' ¬∞C':'‚Äî'}</div>
  <div><div class="k">Dewpoint</div>${dewp?dewp+' ¬∞C':'‚Äî'}</div>
  <div><div class="k">Wind</div>${wdir?wdir+'¬∞':'‚Äî'} @ ${wspd||'‚Äî'} kt</div>
  <div><div class="k">Gust</div>${gust?gust+' kt':'‚Äî'}</div>
  <div><div class="k">Altimeter</div>${alt?alt+' hPa':'‚Äî'}</div></div>
  <div style="margin-top:.5rem;font-family:monospace;font-size:.85rem;background:#f6f8fb;border-left:4px solid ${catColor(cat)};padding:.4rem .5rem;border-radius:8px;white-space:pre-wrap">${raw}</div>`;
  m.bindPopup(html,{maxWidth:360});
}

async function loadAll(){
  const groups=chunk(STATIONS,CHUNK_SIZE); let newestISO=null, bounds=[];
  for(const g of groups){
    try{
      const data=await fetchChunk(g);
      for(const f of data.features||[]){
        const obs=getProp(f.properties,['obsTime','observation_time','observed','observed_utc']);
        if(obs){const iso=/[zZ]$/.test(obs)?obs:obs+'Z';if(!newestISO||new Date(iso)>new Date(newestISO)) newestISO=iso;}
        featureToMarker(f);
        if(f.geometry&&f.geometry.coordinates) bounds.push([f.geometry.coordinates[1],f.geometry.coordinates[0]]);
      }
    }catch(e){console.error(e);}
  }
  if(bounds.length) map.fitBounds(L.latLngBounds(bounds).pad(0.08));
  document.getElementById('lastUpdated').textContent=newestISO?('Data as of '+toLocal(newestISO)):'No data';
}
document.addEventListener('DOMContentLoaded',loadAll);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>North America Flight Conditions — Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body,html{margin:0;height:100%}
    #map{width:100%;height:100%}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    const CSV_URL = "https://raw.githubusercontent.com/NoahCornish/North-America-Flight-Conditions-Research-Project/refs/heads/main/Data/METARs/clean_metars.csv";

    const CAT_COLORS = {
      "VFR": "#2ecc71",
      "MVFR": "#3498db",
      "IFR": "#e74c3c",
      "LIFR": "#8e44ad"
    };

    // ICAO prefix → country
    function countryOf(icao) {
      if (!icao) return null;
      const p = icao[0].toUpperCase();
      if (p === "C") return "Canada";
      if (p === "K" || p === "P") return "United States";
      return null;
    }

    // Map setup
    const map = L.map("map").setView([49.5, -95], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // Load CSV
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      complete: (res) => {
        const rows = res.data.filter(r => r.icao && r.lat && r.lon && r.flight_category);
        rows.forEach(r => {
          const color = CAT_COLORS[r.flight_category] || "gray";
          const lat = parseFloat(r.lat);
          const lon = parseFloat(r.lon);
          if (isNaN(lat) || isNaN(lon)) return;

          const marker = L.circleMarker([lat, lon], {
            radius: 6,
            color: color,
            weight: 1,
            fillColor: color,
            fillOpacity: 0.8
          }).addTo(map);

          marker.bindPopup(`
            <b>${r.icao}</b><br/>
            ${r.site || ""}<br/>
            Category: <b>${r.flight_category}</b><br/>
            Temp: ${r.temp_c || "—"} °C<br/>
            Wind: ${r.wind_dir_deg || "—"}° @ ${r.wind_kts || "—"} kt
          `);
        });
      }
    });
  </script>
</body>
</html>

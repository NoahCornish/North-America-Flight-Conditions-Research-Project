<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>North America Flight Conditions — Live Dashboard & Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Leaflet + clustering -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<!-- pako for gunzip -->
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --ink:#0b2540; --muted:#62748a; --brand:#1a73e8; --accent:#2ecc71;
    --shadow:0 10px 26px rgba(0,0,0,.08);
    --vfr:#2ecc71; --mvfr:#3498db; --ifr:#e74c3c; --lifr:#8e44ad;
    --chip:#eef2f7;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:30;background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;box-shadow:var(--shadow)}
  .wrap{max-width:1200px;margin:0 auto;padding:1rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:1rem}
  .brand{display:flex;gap:.8rem;align-items:center}
  .logo{width:42px;height:42px;border-radius:12px;background:#fff1;border:1px solid #ffffff44;display:grid;place-items:center;font-weight:800}
  .title h1{margin:0;font-size:1.2rem;font-weight:800}
  .title p{margin:.25rem 0 0;opacity:.92;font-weight:600;font-size:.9rem}

  nav{display:flex;gap:.5rem}
  .tabbtn{appearance:none;border:none;background:#ffffff22;color:#fff;font-weight:800;padding:.55rem .9rem;border-radius:12px;cursor:pointer}
  .tabbtn.active{background:#fff;color:var(--brand)}

  main{max-width:1200px;margin:1rem auto;padding:0 1rem 2rem}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:1rem}
  .card{background:var(--card);border-radius:18px;padding:1rem 1.2rem;box-shadow:var(--shadow)}
  .controls{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center}
  select,button{font:inherit}
  select{padding:.6rem .8rem;border:1px solid #d7dee8;border-radius:12px;background:#fff;min-width:240px}
  .note{color:var(--muted);font-size:.92rem}
  .chips{display:flex;flex-wrap:wrap;gap:.4rem}
  .chip{background:var(--chip);color:var(--muted);font-weight:700;border-radius:999px;padding:.28rem .6rem;font-size:.78rem}
  .badge{padding:.15rem .5rem;border-radius:999px;color:#fff;font-weight:800;font-size:.78rem;letter-spacing:.3px}
  .cat-VFR{background:var(--vfr)} .cat-MVFR{background:var(--mvfr)} .cat-IFR{background:var(--ifr)} .cat-LIFR{background:var(--lifr)}
  .kv{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.7rem;margin-top:.4rem}
  .k{color:var(--muted);font-weight:700}
  .monospace{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .raw{background:#f6f8fb;border-left:4px solid var(--brand);padding:.6rem;border-radius:10px;white-space:pre-wrap}

  #mapPage{display:none}
  #map{height:72vh;border-radius:16px}
  .legend{background:#fff;border-radius:12px;padding:.5rem .7rem;box-shadow:var(--shadow);font-size:.85rem}
  .legend .row{display:flex;align-items:center;gap:.45rem;margin:.2rem 0}
  .dot{width:12px;height:12px;border-radius:50%}

  footer{padding:2rem 1rem;color:var(--muted);text-align:center}

  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">✈️</div>
      <div class="title">
        <h1>North America Flight Conditions — Live Dashboard & Map</h1>
        <p>Live METARs • Canada & USA • VFR / MVFR / IFR / LIFR insights</p>
      </div>
    </div>
    <nav>
      <button class="tabbtn active" data-tab="dashPage">Dashboard</button>
      <button class="tabbtn" data-tab="mapPage">Map</button>
    </nav>
    <div class="note" id="lastUpdated">Loading…</div>
  </div>
</header>

<main>
  <!-- DASHBOARD PAGE -->
  <section id="dashPage">
    <section class="grid">
      <!-- Left: National Overview -->
      <article class="card">
        <h2 style="margin:.2rem 0 .6rem">National Overview</h2>
        <div class="controls" style="margin-bottom:.6rem">
          <label class="note" for="country">Region:</label>
          <select id="country">
            <option value="CA" selected>Canada</option>
            <option value="US">USA</option>
          </select>
          <div class="chips" aria-label="Legend">
            <span class="chip"><span class="badge cat-VFR">VFR</span></span>
            <span class="chip"><span class="badge cat-MVFR">MVFR</span></span>
            <span class="chip"><span class="badge cat-IFR">IFR</span></span>
            <span class="chip"><span class="badge cat-LIFR">LIFR</span></span>
          </div>
        </div>

        <div class="chips" style="margin:.25rem 0 .5rem">
          <span id="countVFR"  class="chip" style="background:var(--vfr);color:#fff">VFR: 0 (0%)</span>
          <span id="countMVFR" class="chip" style="background:var(--mvfr);color:#fff">MVFR: 0 (0%)</span>
          <span id="countIFR"  class="chip" style="background:var(--ifr);color:#fff">IFR: 0 (0%)</span>
          <span id="countLIFR" class="chip" style="background:var(--lifr);color:#fff">LIFR: 0 (0%)</span>
          <span id="countTotal" class="chip">Airports counted: 0</span>
        </div>

        <div style="background:#fbfdff;border:1px dashed #cfe2ff;border-radius:14px;padding:12px">
          <canvas id="nationalChart" height="120"></canvas>
        </div>
        <p class="note" style="margin-top:.5rem">Share of latest reports by category for the selected region.</p>
      </article>

      <!-- Right: Airport Explorer -->
      <article class="card">
        <h2 style="margin:.2rem 0 .6rem">Airport Explorer</h2>
        <div class="controls" style="margin-bottom:.7rem">
          <label class="note" for="airport">Airport:</label>
          <select id="airport"><option disabled selected>Loading airports…</option></select>
          <button class="tabbtn" id="open">Show</button>
        </div>

        <div id="airportPanel" style="display:none">
          <div id="apHeader" style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
            <div>
              <div id="apName" style="font-size:1.15rem;font-weight:800"></div>
              <div id="apIcao" class="note"></div>
            </div>
            <span id="apCat" class="badge">—</span>
          </div>

          <div class="chips" style="margin:.5rem 0">
            <span id="apObs" class="chip">Observed: —</span>
          </div>

          <div class="kv">
            <div><div class="k">Temp</div><div id="apTemp">—</div></div>
            <div><div class="k">Dewpoint</div><div id="apDew">—</div></div>
            <div><div class="k">Wind</div><div id="apWind">—</div></div>
            <div><div class="k">Visibility</div><div id="apVis">—</div></div>
            <div><div class="k">Altimeter</div><div id="apAlt">—</div></div>
            <div><div class="k">Gust</div><div id="apGust">—</div></div>
          </div>

          <div class="monospace raw" style="margin-top:.8rem" id="apRaw"></div>
        </div>

        <div id="emptyState" class="note">Select a country, then an airport to view its latest METAR.</div>
      </article>
    </section>

    <!-- About -->
    <section class="card" style="margin-top:1rem">
      <h2 style="margin:.2rem 0 .6rem">About this Research Project</h2>
      <div class="note" style="line-height:1.5">
        <p><strong>Scope.</strong> The North America Flight Conditions Research Project tracks live METARs across Canada and the United States, normalizes them each ~5 minutes, and publishes open summaries of flight rules categories—VFR, MVFR, IFR, and LIFR. The aim is to quantify weather-driven accessibility across regions and seasons.</p>
        <p><strong>Why it matters.</strong> Flight conditions shape training schedules, GA utilization, airline dispatch, and emergency operations. A consistent, transparent view of current states and trends helps pilots, planners, and the public understand how often and where conditions are truly “go/no-go.”</p>
        <p><strong>Data pipeline.</strong> Reports are fetched from AWC METAR feeds, deduplicated and change-filtered (keeping only meaningful changes), and aggregated into national snapshots. We enrich with station metadata (location, names) from AWC’s station catalog.</p>
        <p><strong>Methodology highlights.</strong> We compute national % shares using the latest observation per station; time-series work uses append-only logs. Observations are not forecasts. Altimeter is shown in hPa, visibility in statute miles, winds in knots, temperatures in °C.</p>
        <p><strong>Ethics & reliability.</strong> Sources are public, rate-limited responsibly, and cached. No individual tracking; data is station-level only. Contributions and replication are encouraged—see the public repository for scripts and workflow files.</p>
        <p><strong>Follow the project.</strong> Insights and visual excerpts will be posted to social media. For media or collaboration, please reach out via the repository’s contact or open an issue.</p>
      </div>
    </section>
  </section>

  <!-- MAP PAGE -->
  <section id="mapPage">
    <section class="card" style="margin-bottom:1rem">
      <h2 style="margin:.2rem 0 .6rem">Interactive Map</h2>
      <div class="controls" style="margin-bottom:.6rem">
        <label class="note" for="mapCountry">Region:</label>
        <select id="mapCountry">
          <option value="ALL" selected>All</option>
          <option value="CA">Canada</option>
          <option value="US">USA</option>
        </select>
        <div class="chips">
          <span class="chip"><span class="badge cat-VFR">VFR</span></span>
          <span class="chip"><span class="badge cat-MVFR">MVFR</span></span>
          <span class="chip"><span class="badge cat-IFR">IFR</span></span>
          <span class="chip"><span class="badge cat-LIFR">LIFR</span></span>
        </div>
        <span id="mapStatus" class="note" style="margin-left:auto">Loading stations…</span>
      </div>
      <div id="map"></div>
      <div class="legend" style="position:absolute; right:20px; bottom:25px">
        <div class="row"><span class="dot" style="background:var(--vfr)"></span> VFR</div>
        <div class="row"><span class="dot" style="background:var(--mvfr)"></span> MVFR</div>
        <div class="row"><span class="dot" style="background:var(--ifr)"></span> IFR</div>
        <div class="row"><span class="dot" style="background:var(--lifr)"></span> LIFR</div>
      </div>
    </section>
  </section>
</main>

<footer>
  © <span id="year"></span> North America Flight Conditions Research Project
</footer>

<script>
  // ---------- Config ----------
  const CSV_URL = "https://raw.githubusercontent.com/NoahCornish/North-America-Flight-Conditions-Research-Project/refs/heads/main/Data/METARs/clean_metars.csv";
  const STATIONS_JSON_GZ = "https://aviationweather.gov/data/cache/stations.cache.json.gz"; // daily cache

  // Country inference by ICAO prefix
  function countryOf(icao) {
    if (!icao) return null;
    const p = icao.toUpperCase()[0];
    if (p === 'C') return 'CA';
    if (p === 'K' || p === 'P') return 'US'; // mainland K*, Alaska/Hawaii/territories P*
    return null;
  }

  const $ = (sel) => document.querySelector(sel);
  const toLocal = (utcStr) => {
    if (!utcStr) return '—';
    let s = String(utcStr);
    if (!/[zZ]$/.test(s)) s += 'Z';
    const d = new Date(s);
    try {
      return d.toLocaleString('en-CA', { timeZone: 'America/Toronto', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    } catch { return d.toLocaleString(); }
  };

  // ---------- State ----------
  let latestByIcao = {};             // { ICAO : {data...} }
  let stationsByCountry = { CA: [], US: [] };
  let stationMeta = {};              // { ICAO : {name, lat, lon} }
  let nationalChart = null;
  let map, cluster;

  // Column name resolution
  const COLS = {
    icao:  ['icao','station_id','id','icaoId'],
    name:  ['site','airport_name','name'],
    obs:   ['observed_utc','obsTime','observation_time'],
    cat:   ['flight_category','fltcat','category'],
    temp:  ['temp_c','temp'],
    dewp:  ['dewpoint_c','dewp'],
    wdir:  ['wind_dir_deg','wdir'],
    wspd:  ['wind_kts','wspd'],
    gust:  ['gust_kts','wgst'],
    vis:   ['vis_sm','visib'],
    alt:   ['altimeter_hpa','altim','altimeter_hg'],
    raw:   ['raw_text','rawOb','raw']
  };
  const pick = (row, arr) => { for (const k of arr) if (row[k] !== undefined && row[k] !== null && row[k] !== '') return row[k]; };

  // ---------- Data load ----------
  function processRows(rows) {
    latestByIcao = {};
    let newestISO = null;

    for (const r of rows) {
      const icao = String(pick(r, COLS.icao) || '').toUpperCase().trim();
      const obs  = pick(r, COLS.obs);
      if (!icao || !obs) continue;
      const iso = /[zZ]$/.test(obs) ? obs : (obs + 'Z');
      const t = new Date(iso);
      const prev = latestByIcao[icao];
      if (!prev || t > new Date(prev._iso)) {
        latestByIcao[icao] = {
          _iso: iso,
          icao,
          site: pick(r, COLS.name) || '',
          cat:  String(pick(r, COLS.cat) || '').toUpperCase(),
          temp: parseFloat(pick(r, COLS.temp)),
          dewp: parseFloat(pick(r, COLS.dewp)),
          wdir: parseFloat(pick(r, COLS.wdir)),
          wspd: parseFloat(pick(r, COLS.wspd)),
          gust: parseFloat(pick(r, COLS.gust)),
          vis:  parseFloat(pick(r, COLS.vis)),
          alt:  parseFloat(pick(r, COLS.alt)),
          raw:  pick(r, COLS.raw) || ''
        };
      }
      if (!newestISO || t > new Date(newestISO)) newestISO = iso;
    }

    stationsByCountry = { CA: [], US: [] };
    Object.keys(latestByIcao).sort().forEach(icao => {
      const c = countryOf(icao);
      if (c === 'CA') stationsByCountry.CA.push(icao);
      else if (c === 'US') stationsByCountry.US.push(icao);
    });

    $('#lastUpdated').textContent = newestISO ? ('Data as of ' + toLocal(newestISO)) : 'No data';
  }

  function loadCSV() {
    return new Promise((resolve) => {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        dynamicTyping: false,
        complete: (res) => {
          const rows = (res.data || []).filter(r => Object.keys(r).some(k => (r[k] !== null && r[k] !== '')));
          processRows(rows);
          resolve();
        },
        error: () => { $('#lastUpdated').textContent = 'Failed to load data.'; resolve(); }
      });
    });
  }

  // ---------- Station metadata (name/lat/lon) ----------
  async function loadStationMeta() {
    try {
      const resp = await fetch(STATIONS_JSON_GZ);
      if (!resp.ok) throw new Error('Stations cache fetch failed');
      const buf = await resp.arrayBuffer();
      const u8  = new Uint8Array(buf);
      const jsonStr = new TextDecoder().decode(pako.ungzip(u8));
      const obj = JSON.parse(jsonStr);
      // Build a quick lookup. Keys vary by schema; be tolerant.
      stationMeta = {};
      const arr = Array.isArray(obj) ? obj : (obj.stations || obj.features || []);
      for (const s of arr) {
        const id  = (s.station_id || s.icao || s.id || s.icaoId || '').toUpperCase();
        const nm  = s.site || s.name || s.station || s.city || '';
        const lat = parseFloat(s.latitude  || s.lat || (s.geometry?.coordinates?.[1]));
        const lon = parseFloat(s.longitude || s.lon || (s.geometry?.coordinates?.[0]));
        if (id && Number.isFinite(lat) && Number.isFinite(lon)) {
          stationMeta[id] = { name: nm, lat, lon };
        }
      }
      $('#mapStatus').textContent = 'Stations loaded';
    } catch (e) {
      console.warn('Station metadata load failed:', e);
      $('#mapStatus').textContent = 'Stations metadata unavailable';
    }
  }

  // ---------- UI ----------
  function initUI() {
    $('#year').textContent = new Date().getFullYear();

    // top tabs
    document.querySelectorAll('.tabbtn[data-tab]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.getAttribute('data-tab');
        document.getElementById('dashPage').style.display = (tab==='dashPage')?'block':'none';
        document.getElementById('mapPage').style.display  = (tab==='mapPage')?'block':'none';
        if (tab==='mapPage') setTimeout(()=>map?.invalidateSize(), 150);
      });
    });

    // dashboard controls
    $('#country').addEventListener('change', () => {
      populateAirports();
      renderNational();
      clearAirportPanel();
    });
    $('#open').addEventListener('click', () => {
      const icao = $('#airport').value;
      if (icao) showAirport(icao);
    });

    // map controls
    $('#mapCountry').addEventListener('change', renderMapMarkers);
  }

  function option(label, value) {
    const o = document.createElement('option');
    o.value = value; o.textContent = label; return o;
  }

  function displayName(icao) {
    const siteCsv = latestByIcao[icao]?.site || '';
    const metaNm  = stationMeta[icao]?.name || '';
    const nm = siteCsv || metaNm;
    return nm ? `${icao} — ${nm}` : icao;
  }

  function populateAirports() {
    const sel = $('#airport');
    sel.innerHTML = '';
    const country = $('#country').value;
    const list = stationsByCountry[country] || [];
    if (!list.length) { sel.appendChild(option('No airports found', '')); return; }
    for (const icao of list) sel.appendChild(option(displayName(icao), icao));
  }

  function clearAirportPanel() {
    $('#airportPanel').style.display = 'none';
    $('#emptyState').style.display = 'block';
  }

  function showAirport(icao) {
    const r = latestByIcao[icao];
    if (!r) { clearAirportPanel(); return; }
    const metaNm = stationMeta[icao]?.name || '';
    $('#apName').textContent = r.site || metaNm || icao;
    $('#apIcao').textContent = icao;
    const cat = r.cat || '—';
    const catEl = $('#apCat');
    catEl.textContent = cat;
    catEl.className = 'badge ' + (cat ? ('cat-' + cat) : '');
    $('#apObs').textContent = 'Observed: ' + toLocal(r._iso);
    $('#apTemp').textContent = (Number.isFinite(r.temp) ? (r.temp + ' °C') : '—');
    $('#apDew').textContent  = (Number.isFinite(r.dewp) ? (r.dewp + ' °C') : '—');
    const wind = (Number.isFinite(r.wdir) ? r.wdir + '°' : '—') + ' @ ' + (Number.isFinite(r.wspd) ? r.wspd : '—') + ' kt';
    $('#apWind').textContent = wind;
    $('#apVis').textContent  = (Number.isFinite(r.vis) ? (r.vis + ' sm') : '—');
    $('#apAlt').textContent  = (Number.isFinite(r.alt) ? (r.alt + ' hPa') : '—');
    $('#apGust').textContent = (Number.isFinite(r.gust) ? (r.gust + ' kt') : '—');
    $('#apRaw').textContent  = String(r.raw || '');
    $('#emptyState').style.display = 'none';
    $('#airportPanel').style.display = 'block';
  }

  // ---------- National breakdown ----------
  function computeBreakdown(country) {
    const list = (stationsByCountry[country] || []).map(icao => latestByIcao[icao]).filter(Boolean);
    const counts = { VFR:0, MVFR:0, IFR:0, LIFR:0 };
    for (const r of list) {
      const c = (r.cat || '').toUpperCase();
      if (counts[c] !== undefined) counts[c] += 1;
    }
    const total = list.length || 1;
    const pct = {
      VFR: Math.round((counts.VFR/total)*100),
      MVFR: Math.round((counts.MVFR/total)*100),
      IFR: Math.round((counts.IFR/total)*100),
      LIFR: Math.round((counts.LIFR/total)*100)
    };
    return { counts, pct, total };
  }

  function renderNational() {
    const country = $('#country').value;
    const { counts, pct, total } = computeBreakdown(country);

    const cc = (id, label, n, p) => { const el = document.getElementById(id); if (el) el.textContent = `${label}: ${n} (${p}%)`; };
    cc('countVFR','VFR',counts.VFR,pct.VFR);
    cc('countMVFR','MVFR',counts.MVFR,pct.MVFR);
    cc('countIFR','IFR',counts.IFR,pct.IFR);
    cc('countLIFR','LIFR',counts.LIFR,pct.LIFR);
    const totalEl = document.getElementById('countTotal'); if (totalEl) totalEl.textContent = `Airports counted: ${total}`;

    const ctx = document.getElementById('nationalChart');
    if (nationalChart) { nationalChart.destroy(); }
    nationalChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['VFR','MVFR','IFR','LIFR'],
        datasets: [{
          label: 'Latest reports',
          data: [counts.VFR, counts.MVFR, counts.IFR, counts.LIFR],
          backgroundColor: ['var(--vfr)','var(--mvfr)','var(--ifr)','var(--lifr)']
        }]
      },
      options: {
        plugins: { legend: { display:false } },
        scales: { y: { beginAtZero:true, ticks:{ precision:0 } } }
      }
    });
  }

  // ---------- Map ----------
  function catColor(cat){
    switch(String(cat||'').toUpperCase()){
      case 'VFR': return 'var(--vfr)';
      case 'MVFR': return 'var(--mvfr)';
      case 'IFR': return 'var(--ifr)';
      case 'LIFR': return 'var(--lifr)';
      default: return '#888';
    }
  }

  function initMap(){
    map = L.map('map', { zoomControl: true, worldCopyJump: true }).setView([44, -97], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 18, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    cluster = L.markerClusterGroup({ showCoverageOnHover:false });
    map.addLayer(cluster);
    renderMapMarkers();
  }

  function renderMapMarkers(){
    if (!map || !cluster) return;
    cluster.clearLayers();
    const filter = $('#mapCountry').value; // ALL | CA | US
    let n=0;

    for (const icao of Object.keys(latestByIcao)) {
      const r = latestByIcao[icao];
      const country = countryOf(icao);
      if (filter!=='ALL' && country!==filter) continue;

      const meta = stationMeta[icao];
      if (!meta) continue;
      const { lat, lon } = meta;
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

      const color = catColor(r.cat);
      const marker = L.circleMarker([lat, lon], {
        radius: 7, color: color, fillColor: color, fillOpacity: 0.9, weight: 1
      });

      const name = r.site || meta.name || icao;
      const html = `
        <div style="font-weight:800;margin-bottom:4px">${icao} — ${name}</div>
        <div><span class="badge cat-${r.cat||''}">${r.cat||'—'}</span></div>
        <div class="note" style="margin-top:6px">Observed: ${toLocal(r._iso)}</div>
        <div class="monospace" style="margin-top:6px">${(r.raw||'').replace(/</g,'&lt;')}</div>
        <div class="note" style="margin-top:6px">
          Temp ${Number.isFinite(r.temp)?r.temp+'°C':'—'}, Dew ${Number.isFinite(r.dewp)?r.dewp+'°C':'—'},
          Wind ${Number.isFinite(r.wdir)?r.wdir+'°':'—'} @ ${Number.isFinite(r.wspd)?r.wspd:'—'} kt,
          Vis ${Number.isFinite(r.vis)?r.vis+' sm':'—'}, Alt ${Number.isFinite(r.alt)?r.alt+' hPa':'—'}
        </div>`;
      marker.bindPopup(html, { maxWidth: 380 });
      cluster.addLayer(marker);
      n++;
    }

    $('#mapStatus').textContent = `Plotted ${n} airports`;
    if (n>0) {
      try { map.fitBounds(cluster.getBounds().pad(0.08)); } catch {}
    }
  }

  // ---------- Boot ----------
  (async function(){
    document.getElementById('year').textContent = new Date().getFullYear();
    initUI();
    await loadCSV();
    renderNational();
    populateAirports();

    // Map init after we try to load station metadata
    await loadStationMeta();
    initMap();
  })();
</script>
</body>
</html>

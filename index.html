<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>North America Flight Conditions — Live Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg:#f5f7fb; --card:#fff; --ink:#0b2540; --muted:#62748a; --brand:#1a73e8; --accent:#2ecc71;
    --shadow:0 10px 26px rgba(0,0,0,.08);
    --vfr:#2ecc71; --mvfr:#3498db; --ifr:#e74c3c; --lifr:#8e44ad;
    --chip:#eef2f7;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:30;background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;box-shadow:var(--shadow)}
  .wrap{max-width:1200px;margin:0 auto;padding:1rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
  main{max-width:1200px;margin:1rem auto;padding:0 1rem 2rem;display:grid;gap:1rem}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:1rem}
  .card{background:var(--card);border-radius:18px;padding:1rem 1.2rem;box-shadow:var(--shadow)}
  select{padding:.7rem .9rem;border:1px solid #d7dee8;border-radius:12px;background:#fff;font-size:1rem;width:100%}
  .note{color:var(--muted);font-size:.92rem}
  .badge{padding:.2rem .6rem;border-radius:999px;color:#fff;font-weight:800;font-size:.8rem}
  .cat-VFR{background:var(--vfr)} .cat-MVFR{background:var(--mvfr)} .cat-IFR{background:var(--ifr)} .cat-LIFR{background:var(--lifr)}
  .kv{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.7rem;margin-top:.4rem}
  .k{color:var(--muted);font-weight:700}
  .monospace{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .raw{background:#f6f8fb;border-left:4px solid var(--brand);padding:.6rem;border-radius:10px;white-space:pre-wrap}
  .summary-box{display:flex;flex-wrap:wrap;gap:.4rem;justify-content:center;margin-top:.5rem}
  .chip{border-radius:999px;padding:.3rem .7rem;font-size:.85rem;font-weight:700;color:#fff}
  footer{padding:2rem 1rem;color:var(--muted);text-align:center}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div style="font-weight:800;font-size:1.1rem">✈️ North America Flight Conditions — Live Dashboard</div>
    <div class="note" id="lastUpdated">Loading…</div>
  </div>
</header>

<main>
  <section class="grid">
    <!-- Overview (Pie Charts) -->
    <article class="card">
      <h2>National Overview</h2>
      <div style="display:flex;flex-wrap:wrap;gap:2rem;justify-content:center">
        <div style="text-align:center">
          <h3>Canada</h3>
          <canvas id="chartCA" width="280" height="280"></canvas>
          <div id="summaryCA" class="summary-box"></div>
        </div>
        <div style="text-align:center">
          <h3>USA</h3>
          <canvas id="chartUS" width="280" height="280"></canvas>
          <div id="summaryUS" class="summary-box"></div>
        </div>
      </div>
    </article>

    <!-- Airport Explorer -->
    <article class="card">
      <h2>Airport Explorer</h2>
      <label class="note" for="airport">Airport:</label>
      <select id="airport"><option disabled selected>Select an airport…</option></select>

      <div id="airportPanel" style="display:none;margin-top:1rem">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem">
          <div>
            <div id="apName" style="font-size:1.15rem;font-weight:800"></div>
            <div id="apIcao" class="note"></div>
          </div>
          <span id="apCat" class="badge">—</span>
        </div>
        <div class="kv" style="margin-top:.5rem">
          <div><div class="k">Temp</div><div id="apTemp">—</div></div>
          <div><div class="k">Dewpoint</div><div id="apDew">—</div></div>
          <div><div class="k">Wind</div><div id="apWind">—</div></div>
          <div><div class="k">Visibility</div><div id="apVis">—</div></div>
          <div><div class="k">Altimeter</div><div id="apAlt">—</div></div>
          <div><div class="k">Gust</div><div id="apGust">—</div></div>
        </div>
        <div class="monospace raw" id="apRaw" style="margin-top:.8rem"></div>
      </div>
    </article>
  </section>
</main>

<footer>© <span id="year"></span> North America Flight Conditions Research Project</footer>

<script>
const CSV_URL="https://raw.githubusercontent.com/NoahCornish/North-America-Flight-Conditions-Research-Project/refs/heads/main/Data/METARs/clean_metars.csv";
const $=s=>document.querySelector(s);
const toLocal=s=>{if(!s)return'—';if(!/[zZ]$/.test(s))s+='Z';return new Date(s).toLocaleString();};
function countryOf(icao){if(!icao)return null;const p=icao[0].toUpperCase();if(p==='C')return'CA';if(p==='K'||p==='P')return'US';return null;}

// ✅ Use CSS vars for colours
function cssVar(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim();}
const COLORS={VFR:cssVar("--vfr"),MVFR:cssVar("--mvfr"),IFR:cssVar("--ifr"),LIFR:cssVar("--lifr")};

let latestByIcao={};let charts={};

function processRows(rows){
  latestByIcao={};let newestISO=null;
  for(const r of rows){
    const icao=(r.icao||"").toUpperCase();const obs=r.observed_utc;if(!icao||!obs)continue;
    const iso=/[zZ]$/.test(obs)?obs:obs+'Z';const t=new Date(iso);
    const prev=latestByIcao[icao];if(!prev||t>new Date(prev._iso)){
      latestByIcao[icao]={_iso:iso,icao,site:r.site||"",cat:(r.flight_category||"").toUpperCase(),temp:+r.temp_c,dewp:+r.dewpoint_c,wdir:+r.wind_dir_deg,wspd:+r.wind_kts,gust:+r.gust_kts,vis:+r.vis_sm,alt:+r.altimeter_hpa,raw:r.raw_text||""};
    }
    if(!newestISO||t>new Date(newestISO))newestISO=iso;
  }
  $('#lastUpdated').textContent=newestISO?("Data as of "+toLocal(newestISO)):"No data";
}

function computeBreakdown(country){
  const counts={VFR:0,MVFR:0,IFR:0,LIFR:0};
  Object.values(latestByIcao).forEach(r=>{if(countryOf(r.icao)===country && counts[r.cat]!==undefined)counts[r.cat]++;});
  const total=Object.values(counts).reduce((a,b)=>a+b,0)||1;
  const pct={};Object.keys(counts).forEach(k=>pct[k]=Math.round(counts[k]/total*100));
  return {counts,pct,total};
}

function renderPieCharts(){
  const ctxCA=$("#chartCA"),ctxUS=$("#chartUS");
  const dataCA=computeBreakdown("CA"),dataUS=computeBreakdown("US");
  if(charts.CA)charts.CA.destroy();if(charts.US)charts.US.destroy();
  charts.CA=new Chart(ctxCA,{type:"pie",data:{labels:Object.keys(dataCA.counts),datasets:[{data:Object.values(dataCA.counts),backgroundColor:Object.keys(dataCA.counts).map(k=>COLORS[k])}]},options:{plugins:{legend:{display:false}}}});
  charts.US=new Chart(ctxUS,{type:"pie",data:{labels:Object.keys(dataUS.counts),datasets:[{data:Object.values(dataUS.counts),backgroundColor:Object.keys(dataUS.counts).map(k=>COLORS[k])}]},options:{plugins:{legend:{display:false}}}});
  renderSummaryBox("summaryCA",dataCA);renderSummaryBox("summaryUS",dataUS);
}

function renderSummaryBox(id,data){
  const box=$("#"+id);box.innerHTML="";
  Object.keys(data.counts).forEach(k=>{
    const el=document.createElement("span");
    el.className="chip";el.style.background=COLORS[k];
    el.textContent=`${k}: ${data.counts[k]} (${data.pct[k]}%)`;
    box.appendChild(el);
  });
}

function populateAirports(){
  const sel=$("#airport");sel.innerHTML="";sel.appendChild(new Option("Select an airport…","",true,true));
  Object.values(latestByIcao).forEach(r=>sel.appendChild(new Option(r.icao+" — "+r.site,r.icao)));
}

function showAirport(icao){
  const r=latestByIcao[icao];if(!r)return;
  $("#apName").textContent=r.site||icao;$("#apIcao").textContent=icao;
  $("#apCat").textContent=r.cat;$("#apCat").className="badge cat-"+(r.cat||"");
  $("#apTemp").textContent=isFinite(r.temp)?r.temp+" °C":"—";$("#apDew").textContent=isFinite(r.dewp)?r.dewpoint+" °C":"—";
  $("#apWind").textContent=(isFinite(r.wdir)?r.wdir+"°":"—")+" @ "+(isFinite(r.wspd)?r.wspd:"—")+" kt";
  $("#apVis").textContent=isFinite(r.vis)?r.vis+" sm":"—";$("#apAlt").textContent=isFinite(r.alt)?r.alt+" hPa":"—";
  $("#apGust").textContent=isFinite(r.gust)?r.gust+" kt":"0 kt";$("#apRaw").textContent=r.raw||"";
  $("#airportPanel").style.display="block";
}

Papa.parse(CSV_URL,{download:true,header:true,complete:(res)=>{
  const clean=res.data.filter(r=>Object.values(r).some(v=>v));
  processRows(clean);renderPieCharts();populateAirports();
  $("#airport").addEventListener("change",e=>{if(e.target.value)showAirport(e.target.value);});
}});
$("#year").textContent=new Date().getFullYear();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>North America Flight Conditions — Research Dashboard (Test)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --ink:#0b2540; --muted:#62748a; --brand:#1a73e8; --accent:#2ecc71;
    --shadow:0 10px 26px rgba(0,0,0,.08); --ring:#d7dee8;
    --vfr:#2ecc71; --mvfr:#3498db; --ifr:#e74c3c; --lifr:#8e44ad;
    --chip:#eef2f7; --chip-ink:#334155;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0f172a; --ink:#e2e8f0; --muted:#93a4b8; --brand:#4f8dff; --accent:#37d084;
    --shadow:0 10px 30px rgba(0,0,0,.35); --ring:#19243d;
    --chip:#0b2540; --chip-ink:#cbd5e1;
    --vfr:#38d39f; --mvfr:#4ea8de; --ifr:#ef4444; --lifr:#a78bfa;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;box-shadow:var(--shadow)}
  .wrap{max-width:1200px;margin:0 auto;padding:.8rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-wrap:wrap}
  .brand{font-weight:800;font-size:1.05rem;letter-spacing:.2px;display:flex;align-items:center;gap:.5rem}
  .sub{opacity:.9;font-weight:600;font-size:.9rem}
  .bar{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}
  .pill{background:rgba(255,255,255,.15);padding:.25rem .55rem;border-radius:999px;font-size:.82rem}
  .toggle{appearance:none;width:44px;height:26px;background:#ffffff3b;border-radius:999px;position:relative;cursor:pointer;border:1px solid #ffffff55}
  .toggle:before{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.2s}
  .toggle:checked{background:#0000003b}
  .toggle:checked:before{transform:translateX(18px)}

  main{max-width:1200px;margin:1rem auto;padding:0 1rem 2rem;display:grid;gap:1rem}
  .card{background:var(--card);border-radius:18px;padding:1.1rem 1.2rem;box-shadow:var(--shadow);border:1px solid var(--ring)}
  .card h2{margin:.1rem 0 .8rem;font-size:1.15rem}
  .note{color:var(--muted);font-size:.92rem}
  .badge{padding:.25rem .6rem;border-radius:999px;color:#fff;font-weight:800;font-size:.8rem;box-shadow:var(--shadow)}
  .cat-VFR{background:var(--vfr)} .cat-MVFR{background:var(--mvfr)} .cat-IFR{background:var(--ifr)} .cat-LIFR{background:var(--lifr)}
  .chip{border-radius:999px;padding:.25rem .6rem;font-size:.78rem;font-weight:700;color:var(--chip-ink);background:var(--chip);border:1px solid var(--ring)}
  .chip.color{color:#fff;border:none}

  /* Overview pies */
  .legend{display:flex;flex-wrap:wrap;gap:.4rem}
  .legend .chip{cursor:pointer;transition:.12s transform}
  .legend .chip:hover{transform:translateY(-1px)}
  .pie-container{display:flex;flex-wrap:wrap;gap:1.25rem;justify-content:center}
  .pie-block{flex:1 1 240px;max-width:300px;text-align:center}
  .summary-box{display:flex;flex-wrap:wrap;gap:.35rem;justify-content:center;margin-top:.5rem}
  canvas.pie{max-width:220px !important;max-height:220px !important;margin:0 auto}

  /* Trend (bigger + region toggle) */
  .seg{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.5rem}
  .seg .seg-btn{border:1px solid var(--ring);background:var(--card);color:var(--ink);padding:.45rem .8rem;border-radius:10px;font-weight:700;cursor:pointer}
  .seg .seg-btn.active{background:var(--brand);color:#fff;border-color:transparent}
  #trendChart{width:100%;height:460px !important}

  /* Leaderboards */
  .controls{display:flex;gap:.6rem;flex-wrap:wrap;margin:.2rem 0 .6rem}
  select,input[type="number"],input[type="text"]{padding:.55rem .7rem;border:1px solid var(--ring);border-radius:10px;background:var(--card);color:var(--ink)}
  .row{display:grid;grid-template-columns:1.1fr .9fr;gap:1rem}
  @media(max-width:1000px){.row{grid-template-columns:1fr}}

  /* Feed */
  .feed{display:grid;gap:.6rem;max-height:540px;overflow:auto;padding-right:.2rem}
  .feed-item{display:flex;align-items:center;justify-content:space-between;gap:.6rem;border:1px solid var(--ring);background:var(--card);border-radius:12px;padding:.5rem .65rem;cursor:pointer}
  .feed-left{display:flex;align-items:center;gap:.55rem}
  .icao{font-weight:800}
  .site{color:var(--muted);font-size:.85rem}
  .time{color:var(--muted);font-size:.82rem}

  /* Live METAR viewer */
  .table-wrap{overflow:auto;border:1px solid var(--ring);border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:var(--card);z-index:1}
  th, td{padding:.6rem .7rem;border-bottom:1px solid var(--ring);white-space:nowrap}
  tbody tr:last-child td{border-bottom:none}
  .right{text-align:right}
  .nowrap{white-space:nowrap}
  .btn{border:1px solid var(--ring);background:var(--card);color:var(--ink);padding:.5rem .85rem;border-radius:10px;font-weight:800;cursor:pointer}
  .btn.brand{background:var(--brand);color:#fff;border-color:transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .chips{display:flex;gap:.5rem;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">✈️ North America Flight Conditions — <span class="sub">Research Dashboard</span></div>
    <div class="bar">
      <span class="pill" id="lastUpdated">Loading…</span>
      <span class="pill" id="metaLine">—</span>
      <label class="pill" style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
        <span>Dark</span><input id="themeToggle" class="toggle" type="checkbox" />
      </label>
    </div>
  </div>
</header>

<main>
  <!-- National overview pies -->
  <section class="card">
    <h2>National Overview</h2>
    <div class="legend" id="legendChips">
      <span class="chip color" data-cat="VFR" style="background:var(--vfr)">VFR</span>
      <span class="chip color" data-cat="MVFR" style="background:var(--mvfr)">MVFR</span>
      <span class="chip color" data-cat="IFR" style="background:var(--ifr)">IFR</span>
      <span class="chip color" data-cat="LIFR" style="background:var(--lifr)">LIFR</span>
    </div>
    <div class="pie-container" style="margin-top:.6rem">
      <div class="pie-block">
        <h3>Canada</h3>
        <canvas id="chartCA" class="pie"></canvas>
        <div id="summaryCA" class="summary-box"></div>
      </div>
      <div class="pie-block">
        <h3>USA</h3>
        <canvas id="chartUS" class="pie"></canvas>
        <div id="summaryUS" class="summary-box"></div>
      </div>
    </div>
  </section>

  <!-- Bigger Trend: % IFR+LIFR, MVFR, VFR (region toggle) -->
  <section class="card">
    <h2>24-Hour Trend — % by Category</h2>
    <div class="seg">
      <button class="seg-btn active" data-region="CA">Canada</button>
      <button class="seg-btn" data-region="US">USA</button>
    </div>
    <canvas id="trendChart"></canvas>
    <div class="note" style="margin-top:.4rem">
      Three series: <strong>IFR+LIFR</strong>, <strong>MVFR</strong>, <strong>VFR</strong> (share of observations per hour).
    </div>
  </section>

  <!-- Leaderboards powered by airport_flight_share.csv -->
  <section class="card">
    <h2>Airport Category Share — Leaderboards</h2>
    <div class="controls">
      <label>Region:
        <select id="lbRegion">
          <option value="CA">Canada</option>
          <option value="US">USA</option>
          <option value="ALL">All</option>
        </select>
      </label>
      <label>Category:
        <select id="lbCategory">
          <option value="IFR_LIFR">% IFR+LIFR</option>
          <option value="MVFR">% MVFR</option>
          <option value="VFR">% VFR</option>
        </select>
      </label>
      <label>Min obs:
        <input id="lbMinObs" type="number" value="200" min="0" step="50" />
      </label>
      <label>Top N:
        <input id="lbTopN" type="number" value="10" min="5" max="30" />
      </label>
    </div>
    <div class="row">
      <div>
        <canvas id="lbChart" height="360"></canvas>
      </div>
      <div>
        <div class="note" id="lbNotes">—</div>
        <div id="lbTable" class="note" style="margin-top:.6rem"></div>
      </div>
    </div>
  </section>

  <!-- LIVE METAR VIEWER -->
  <section class="card">
    <h2>Live METAR Viewer</h2>
    <div class="controls">
      <label style="flex:2;min-width:260px">ICAOs (comma/space-separated)
        <input id="lvIcaos" type="text" placeholder="CYTZ CYYZ KSEA KJFK" />
      </label>
      <label>Past hours
        <select id="lvHours">
          <option>3</option><option selected>6</option><option>12</option><option>24</option><option>48</option>
        </select>
      </label>
      <label>Per-station limit
        <select id="lvPer">
          <option>3</option><option selected>5</option><option>10</option><option>25</option>
        </select>
      </label>
      <label>Sort
        <select id="lvSort">
          <option value="desc" selected>Newest → Oldest</option>
          <option value="asc">Oldest → Newest</option>
        </select>
      </label>
    </div>
    <div class="chips" style="margin:-.2rem 0 .5rem">
      <label class="chip"><input id="lvIFRLIFR" type="checkbox" checked style="transform:translateY(2px);margin-right:.35rem"> IFR+LIFR</label>
      <label class="chip"><input id="lvMVFR" type="checkbox" checked style="transform:translateY(2px);margin-right:.35rem"> MVFR</label>
      <label class="chip"><input id="lvVFR" type="checkbox" checked style="transform:translateY(2px);margin-right:.35rem"> VFR</label>
      <label class="chip"><input id="lvAutoCopy" type="checkbox" style="transform:translateY(2px);margin-right:.35rem"> Auto-copy RAW on row click</label>
    </div>
    <div class="controls">
      <button id="lvRun" class="btn brand">Load METARs</button>
      <button id="lvReload" class="btn">Reload data</button>
      <button id="lvDownload" class="btn">Download CSV</button>
      <span class="note" id="lvInfo">—</span>
    </div>
    <div class="table-wrap">
      <table id="lvTable">
        <thead>
          <tr>
            <th>Local Time</th>
            <th>ICAO</th>
            <th>Site</th>
            <th>Cat</th>
            <th>Wind</th>
            <th>Vis</th>
            <th>Alt</th>
            <th>Temp/Dew</th>
            <th>RAW</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="lvBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Recent feed -->
  <section class="card">
    <h2>Recent METAR Updates</h2>
    <div class="feed" id="feed"></div>
    <div class="note" style="margin-top:.5rem" id="feedInfo">—</div>
  </section>

  <!-- About -->
  <section class="card">
    <h2>About This Research Project</h2>
    <p class="note">
      Live monitoring of <code>METAR</code> reports across Canada and the USA. National snapshots, a 24-hour category trend,
      airport leaderboards, and a Live METAR viewer. Data updates ~every 5 minutes from <code>clean_metars.csv</code>.
    </p>
  </section>
</main>

<footer>
  © <span id="year"></span> North America Flight Conditions Research Project · Built with ❤️ for aviation & data science
</footer>

<script>
/* ----------------------- Config & helpers ----------------------- */
const CSV_METARS="https://raw.githubusercontent.com/NoahCornish/North-America-Flight-Conditions-Research-Project/refs/heads/main/Data/METARs/clean_metars.csv";
const CSV_SHARE ="https://raw.githubusercontent.com/NoahCornish/North-America-Flight-Conditions-Research-Project/refs/heads/main/Data/Summaries/airport_flight_share.csv";

const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const cssVar=n=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
const COLORS={VFR:cssVar("--vfr"),MVFR:cssVar("--mvfr"),IFR:cssVar("--ifr"),LIFR:cssVar("--lifr")};
const toLocal=s=>{if(!s)return'—';if(!/[zZ]$/.test(s))s+='Z';return new Date(s).toLocaleString();};
const toTime=s=>{if(!s)return'—';if(!/[zZ]$/.test(s))s+='Z';const d=new Date(s);return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});}
function countryOf(icao){if(!icao)return null;const p=icao[0].toUpperCase();if(p==='C')return'CA';if(p==='K'||p==='P')return'US';return null;}
function asNum(v){const n=+v; return isFinite(n)?n:NaN;}

/* Theme */
const themeToggle=$("#themeToggle");
(()=>{const saved=localStorage.getItem("nafcrp_theme"); if(saved==="dark"){document.documentElement.setAttribute("data-theme","dark"); themeToggle.checked=true;}})();
themeToggle.addEventListener("change",()=>{
  if(themeToggle.checked){document.documentElement.setAttribute("data-theme","dark"); localStorage.setItem("nafcrp_theme","dark");}
  else{document.documentElement.removeAttribute("data-theme"); localStorage.setItem("nafcrp_theme","light");}
});

/* State */
let allRows=[], latestByIcao={}, newestISO=null, hiddenCats=new Set();
let charts={CA:null, US:null, lb:null, trend:null};
let shareRows=[];

/* ----------------------- Load data ----------------------- */
function loadMetars(cb){
  console.time("parse-metars");
  Papa.parse(CSV_METARS,{download:true, header:true, worker:true, complete:(res)=>{
    console.timeEnd("parse-metars");
    allRows = res.data.filter(r=>Object.values(r).some(v=>v)); // drop empties
    processLatest(allRows);
    $('#lastUpdated').textContent=newestISO?("Data as of "+toLocal(newestISO)):"No data";
    $("#metaLine").textContent = `${Object.keys(latestByIcao).length} airports · ${allRows.length.toLocaleString()} rows`;
    cb && cb();
  }});
}
function loadShare(cb){
  console.time("parse-share");
  Papa.parse(CSV_SHARE,{download:true, header:true, worker:true, complete:(res)=>{
    console.timeEnd("parse-share");
    shareRows = res.data.filter(r=>Object.values(r).some(v=>v));
    cb && cb();
  }});
}
loadMetars(()=>{
  renderOverview();
  renderTrend("CA");
  renderFeed();
});
loadShare(()=>initLeaderboards());

/* ----------------------- Processing ----------------------- */
function processLatest(rows){
  latestByIcao={}; newestISO=null;
  for(const r of rows){
    const icao=(r.icao||"").toUpperCase(); const obs=r.observed_utc;
    if(!icao||!obs) continue;
    const iso=/[zZ]$/.test(obs)?obs:obs+'Z';
    const t=new Date(iso);
    const prev=latestByIcao[icao];
    if(!prev || t>new Date(prev._iso)){
      latestByIcao[icao]={
        _iso:iso, icao, site:r.site||"", cat:(r.flight_category||"").toUpperCase(),
        temp:asNum(r.temp_c), dewp:asNum(r.dewpoint_c), wdir:asNum(r.wind_dir_deg),
        wspd:asNum(r.wind_kts), gust:asNum(r.gust_kts), vis:asNum(r.vis_sm),
        alt:asNum(r.altimeter_hpa), raw:r.raw_text||""
      };
    }
    if(!newestISO || t>new Date(newestISO)) newestISO=iso;
  }
}

/* ----------------------- Overview pies ----------------------- */
function computeBreakdown(country){
  const counts={VFR:0,MVFR:0,IFR:0,LIFR:0};
  Object.values(latestByIcao).forEach(r=>{
    if(country && countryOf(r.icao)!==country) return;
    if(hiddenCats.has(r.cat)) return;
    if(counts[r.cat]!=null) counts[r.cat]++;
  });
  const total=Object.values(counts).reduce((a,b)=>a+b,0)||1;
  const pct=Object.fromEntries(Object.keys(counts).map(k=>[k, Math.round(counts[k]/total*100)]));
  return {counts,pct,total};
}
function renderSummaryBox(id,data){
  const box=$("#"+id); box.innerHTML="";
  Object.keys(data.counts).forEach(k=>{
    if(hiddenCats.has(k)) return;
    const el=document.createElement("span");
    el.className="chip color"; el.style.background=COLORS[k];
    el.textContent=`${k}: ${data.counts[k]} (${data.pct[k]}%)`;
    box.appendChild(el);
  });
}
function renderOverview(){
  const ctxCA=$("#chartCA"), ctxUS=$("#chartUS");
  const dataCA=computeBreakdown("CA"), dataUS=computeBreakdown("US");
  if(charts.CA)charts.CA.destroy(); if(charts.US)charts.US.destroy();

  const labels = Object.keys(dataCA.counts).filter(k=>!hiddenCats.has(k));
  const bg = labels.map(k=>COLORS[k]);
  const ds=(obj)=>labels.map(k=>obj.counts[k]||0);

  charts.CA=new Chart(ctxCA,{type:"pie",data:{labels,datasets:[{data:ds(dataCA),backgroundColor:bg}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false}});
  charts.US=new Chart(ctxUS,{type:"pie",data:{labels,datasets:[{data:ds(dataUS),backgroundColor:bg}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false}});
  renderSummaryBox("summaryCA",dataCA);
  renderSummaryBox("summaryUS",dataUS);

  // legend toggles
  $$("#legendChips .chip").forEach(ch=>{
    ch.onclick=()=>{
      const cat=ch.dataset.cat;
      if(hiddenCats.has(cat)){ hiddenCats.delete(cat); ch.style.opacity=1; }
      else { hiddenCats.add(cat); ch.style.opacity=.4; }
      renderOverview();
    };
  });
}

/* ----------------------- Trend (percent series) ----------------------- */
function hourKey(iso){ const d=new Date(/[zZ]$/.test(iso)?iso:iso+'Z'); d.setMinutes(0,0,0); return d.toISOString(); }
function computeTrend(region){
  const buckets=new Map(); // hour -> {total,vfr,mvfr,ifr,lifr}
  for(const r of allRows){
    const icao=(r.icao||"").toUpperCase(); if(!icao) continue;
    if(region && countryOf(icao)!==region) continue;
    const obs=r.observed_utc; if(!obs) continue;
    const key=hourKey(obs);
    const cat=(r.flight_category||"").toUpperCase();
    const obj=buckets.get(key)||{total:0,vfr:0,mvfr:0,ifr:0,lifr:0};
    obj.total++;
    if(cat==="VFR") obj.vfr++;
    else if(cat==="MVFR") obj.mvfr++;
    else if(cat==="IFR") obj.ifr++;
    else if(cat==="LIFR") obj.lifr++;
    buckets.set(key,obj);
  }
  const keys=[...buckets.keys()].sort((a,b)=>new Date(a)-new Date(b)).slice(-24);
  const labels=keys.map(k=>new Date(k).toLocaleTimeString([], {hour:'2-digit'}));
  const pct=(n,t)=>Math.round(100*(n/(t||1)));
  const series = keys.map(k=>buckets.get(k)).map(v=>({
    vfr: pct(v.vfr,v.total), mvfr: pct(v.mvfr,v.total), ifrlifr: pct(v.ifr+v.lifr,v.total)
  }));
  return {labels, vfr:series.map(s=>s.vfr), mvfr:series.map(s=>s.mvfr), ifrlifr:series.map(s=>s.ifrlifr)};
}
function renderTrend(region){
  const segBtns=$$(".seg .seg-btn");
  segBtns.forEach(b=>b.classList.toggle("active", b.dataset.region===region));
  const t=computeTrend(region);
  if(charts.trend) charts.trend.destroy();
  charts.trend=new Chart($("#trendChart"),{
    type:"line",
    data:{
      labels:t.labels,
      datasets:[
        {label:"IFR+LIFR", data:t.ifrlifr, borderWidth:3, tension:.25},
        {label:"MVFR", data:t.mvfr, borderWidth:3, tension:.25},
        {label:"VFR", data:t.vfr, borderWidth:3, tension:.25}
      ]
    },
    options:{scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+"%"}},x:{ticks:{maxRotation:0}}},plugins:{legend:{position:'bottom'}},maintainAspectRatio:false}
  });
  segBtns.forEach(b=>b.onclick=()=>renderTrend(b.dataset.region));
}

/* ----------------------- Leaderboards (airport_flight_share.csv) ----------------------- */
function normKeys(obj){const n={}; for(const k of Object.keys(obj)){ n[k.toLowerCase().replace(/[^a-z0-9]+/g,'_')]=k; } return n;}
function pick(obj, names){const nk=normKeys(obj); for(const nm of names){ const k=nk[nm]; if(k!=null) return obj[k]; } return undefined;}
function toNumSafe(v){ const n=+v; return isFinite(n)?n:NaN; }

function computeShareRow(r){
  const c_icao = pick(r,["icao","station","id"]);
  const c_site = pick(r,["site","name","station_name"]);
  const tot = toNumSafe(pick(r,["total_obs","obs_total","n_total","total","count_total","observations","n"]));
  let sh_vfr = toNumSafe(pick(r,["vfr_share","share_vfr","pct_vfr","vfr_pct","vfr_percent","percent_vfr","vfr_ratio"]));
  let sh_mvfr= toNumSafe(pick(r,["mvfr_share","share_mvfr","pct_mvfr","mvfr_pct","mvfr_percent","percent_mvfr","mvfr_ratio"]));
  let sh_ifr = toNumSafe(pick(r,["ifr_share","share_ifr","pct_ifr","ifr_pct","ifr_percent","percent_ifr","ifr_ratio"]));
  let sh_lifr= toNumSafe(pick(r,["lifr_share","share_lifr","pct_lifr","lifr_pct","lifr_percent","percent_lifr","lifr_ratio"]));

  if(!(isFinite(sh_vfr)||isFinite(sh_mvfr)||isFinite(sh_ifr)||isFinite(sh_lifr))){
    const c_vfr = toNumSafe(pick(r,["vfr","vfr_count","count_vfr"]));
    const c_mvfr= toNumSafe(pick(r,["mvfr","mvfr_count","count_mvfr"]));
    const c_ifr = toNumSafe(pick(r,["ifr","ifr_count","count_ifr"]));
    const c_lifr= toNumSafe(pick(r,["lifr","lifr_count","count_lifr"]));
    const sum = (isFinite(tot)&&tot>0)?tot:([c_vfr,c_mvfr,c_ifr,c_lifr].filter(x=>isFinite(x)).reduce((a,b)=>a+b,0));
    sh_vfr = isFinite(c_vfr)&&sum? (c_vfr/sum*100):NaN;
    sh_mvfr= isFinite(c_mvfr)&&sum? (c_mvfr/sum*100):NaN;
    sh_ifr = isFinite(c_ifr)&&sum? (c_ifr/sum*100):NaN;
    sh_lifr= isFinite(c_lifr)&&sum? (c_lifr/sum*100):NaN;
  } else {
    [sh_vfr,sh_mvfr,sh_ifr,sh_lifr] = [sh_vfr,sh_mvfr,sh_ifr,sh_lifr].map(x=>isFinite(x)?(x>1.001?x:x*100):NaN);
  }
  const ifr_lifr = (isFinite(sh_ifr)?sh_ifr:0) + (isFinite(sh_lifr)?sh_lifr:0);
  return {icao:(c_icao||"").toUpperCase(), site:c_site||"", total:isFinite(tot)?Math.round(tot):NaN, vfr:isFinite(sh_vfr)?sh_vfr:NaN, mvfr:isFinite(sh_mvfr)?sh_mvfr:NaN, ifr_lifr:isFinite(ifr_lifr)?ifr_lifr:NaN};
}
function initLeaderboards(){
  const cooked = shareRows.map(computeShareRow).filter(r=>r.icao);
  const elR=$("#lbRegion"), elC=$("#lbCategory"), elM=$("#lbMinObs"), elN=$("#lbTopN");
  function refresh(){
    const region=elR.value, cat=elC.value, minObs=+elM.value||0, topN=Math.min(Math.max(+elN.value||10,5),30);
    const filtered = cooked.filter(r=>{
      if(minObs && !(isFinite(r.total) && r.total>=minObs)) return false;
      if(region==="CA" && countryOf(r.icao)!=="CA") return false;
      if(region==="US" && countryOf(r.icao)!=="US") return false;
      return isFinite(r[cat]);
    });
    filtered.sort((a,b)=>b[cat]-a[cat]);
    const top = filtered.slice(0, topN);
    renderLBChart(top, cat); renderLBTable(top, cat, region, minObs);
  }
  [elR,elC,elM,elN].forEach(el=>el.addEventListener("change", refresh));
  refresh();
}
function renderLBChart(rows, cat){
  const ctx=$("#lbChart"); if(charts.lb) charts.lb.destroy();
  const labels = rows.map(r=>r.icao).reverse();
  const data   = rows.map(r=>Math.round(r[cat]*10)/10).reverse();
  charts.lb=new Chart(ctx,{type:"bar",data:{labels,datasets:[{label: labelForCat(cat), data, borderWidth:1}]},options:{indexAxis:'y',scales:{ x:{ beginAtZero:true, max:100, ticks:{callback:v=>v+"%"} } },plugins:{ legend:{display:false}, tooltip:{callbacks:{label:(c)=>`${c.raw}%`}} },maintainAspectRatio:false}});
}
function labelForCat(cat){ if(cat==="IFR_LIFR") return "% IFR+LIFR"; if(cat==="MVFR") return "% MVFR"; return "% VFR"; }
function renderLBTable(rows, cat, region, minObs){
  $("#lbNotes").textContent = `Showing top ${rows.length} airports by ${labelForCat(cat)} — Region: ${region}, Min obs: ${minObs}`;
  const html = rows.map(r=>`<div>• <b>${r.icao}</b> — ${r.site ? r.site+" — " : ""}${labelForCat(cat)}: <b>${(Math.round(r[cat]*10)/10).toFixed(1)}%</b>${isFinite(r.total)?` · n=${r.total}`:""}</div>`).join("");
  $("#lbTable").innerHTML = html || "No rows match filters.";
}

/* ----------------------- Recent feed ----------------------- */
function renderFeed(){
  const feed=$("#feed"); feed.innerHTML="";
  const withObs = allRows.filter(r=>r.observed_utc && r.icao);
  withObs.sort((a,b)=>new Date(b.observed_utc)-new Date(a.observed_utc));
  const chosen = withObs.slice(0,25);
  for(const r of chosen){
    const icao=(r.icao||"").toUpperCase();
    const cat=(r.flight_category||"").toUpperCase();
    const item=document.createElement("div"); item.className="feed-item";
    const left=document.createElement("div"); left.className="feed-left";
    const b=document.createElement("span"); b.className="badge cat-"+cat; b.textContent=cat||"—";
    const i=document.createElement("span"); i.className="icao"; i.textContent=icao||"—";
    const s=document.createElement("span"); s.className="site"; s.textContent=r.site||"";
    left.append(b,i,s);
    const t=document.createElement("span"); t.className="time"; t.textContent=toTime(r.observed_utc);
    item.append(left,t);
    item.onclick=()=>{
      const latest = latestByIcao[icao]; if(!latest) return;
      const info =
`${latest.site||icao} (${icao})
Obs: ${toTime(latest._iso)}
CAT: ${latest.cat}
Wind: ${isFinite(latest.wdir)?latest.wdir+"°":""} @ ${isFinite(latest.wspd)?latest.wspd+" kt":"—"} ${isFinite(latest.gust)?" G"+latest.gust:""}
Vis: ${isFinite(latest.vis)?latest.vis+" sm":"—"}
Alt: ${isFinite(latest.alt)?latest.alt+" hPa":"—"}

RAW: ${latest.raw||""}`;
      navigator.clipboard.writeText(latest.raw||"");
      alert(info+"\n\n(RAW copied to clipboard)");
    };
    feed.appendChild(item);
  }
  $("#feedInfo").textContent = `Showing ${chosen.length} most recent observations`;
}

/* ----------------------- Live METAR Viewer ----------------------- */
const lv = {
  icaos: $("#lvIcaos"),
  hours: $("#lvHours"),
  per: $("#lvPer"),
  sort: $("#lvSort"),
  chkIFRLIFR: $("#lvIFRLIFR"),
  chkMVFR: $("#lvMVFR"),
  chkVFR: $("#lvVFR"),
  run: $("#lvRun"),
  reload: $("#lvReload"),
  dl: $("#lvDownload"),
  autoCopy: $("#lvAutoCopy"),
  body: $("#lvBody"),
  info: $("#lvInfo")
};

(function initLV(){
  // restore ICAOs from localStorage
  const saved = localStorage.getItem("lv_icaos");
  if(saved) lv.icaos.value = saved;

  lv.run.onclick = runLV;
  lv.reload.onclick = ()=>loadMetars(()=>{ runLV(); renderOverview(); renderTrend($(".seg-btn.active")?.dataset.region || "CA"); renderFeed(); });
  lv.dl.onclick = downloadLV;
  // default examples if empty:
  if(!lv.icaos.value.trim()) lv.icaos.value = "CYTZ CYYZ CYOW KJFK KBOS";
})();

function parseICAOs(txt){
  return [...new Set(txt.toUpperCase().split(/[^A-Z0-9]+/).filter(x=>x.length>=3 && x.length<=5))].sort();
}
function runLV(){
  const picks = parseICAOs(lv.icaos.value);
  localStorage.setItem("lv_icaos", lv.icaos.value);
  const hours = +lv.hours.value || 6;
  const perStation = +lv.per.value || 5;
  const sortDir = lv.sort.value; // "desc" or "asc"
  const allowIFR = lv.chkIFRLIFR.checked, allowMVFR=lv.chkMVFR.checked, allowVFR=lv.chkVFR.checked;

  const now = Date.now();
  const cutoff = now - hours*3600*1000;

  // Build filtered list
  let out = [];
  const perCount = Object.create(null);

  // Pre-sort allRows by time according to sort selection for consistent limiting
  const rows = allRows.filter(r=>r.observed_utc && r.icao);
  rows.sort((a,b)=> sortDir==="desc" ? (new Date(b.observed_utc)-new Date(a.observed_utc))
                                     : (new Date(a.observed_utc)-new Date(b.observed_utc)));

  for(const r of rows){
    const icao=(r.icao||"").toUpperCase(); if(!icao) continue;
    if(picks.length && !picks.includes(icao)) continue;

    const t = new Date(/[zZ]$/.test(r.observed_utc)?r.observed_utc:r.observed_utc+'Z').getTime();
    if(!(t>=cutoff)) continue;

    const cat=(r.flight_category||"").toUpperCase();
    const inCat = (allowIFR && (cat==="IFR"||cat==="LIFR")) || (allowMVFR && cat==="MVFR") || (allowVFR && cat==="VFR");
    if(!inCat) continue;

    const n = (perCount[icao]||0);
    if(n>=perStation) continue; // respect per-station limit
    perCount[icao]=n+1;

    out.push({
      icao, site:r.site||"", obs:r.observed_utc, cat,
      wdir:asNum(r.wind_dir_deg), wspd:asNum(r.wind_kts), gust:asNum(r.gust_kts),
      vis:asNum(r.vis_sm), alt:asNum(r.altimeter_hpa), temp:asNum(r.temp_c), dewp:asNum(r.dewpoint_c),
      raw:r.raw_text||""
    });
  }

  renderLV(out, sortDir);
  lv.info.textContent = `${out.length} rows · ${picks.length? picks.join(", "):"All picked"} · past ${hours}h · ${perStation}/station · ${sortDir}`;
}

function renderLV(rows, sortDir){
  lv.body.innerHTML = "";
  for(const r of rows){
    const tr=document.createElement("tr");
    const timeCell = `<td class="nowrap">${toLocal(r.obs)}</td>`;
    const icaoCell = `<td><b>${r.icao}</b></td>`;
    const siteCell = `<td class="note">${r.site||""}</td>`;
    const catCell  = `<td><span class="badge cat-${r.cat}">${r.cat}</span></td>`;
    const windTxt  = `${isFinite(r.wdir)?r.wdir+"°":""} ${isFinite(r.wspd)?("@ "+r.wspd+" kt"):""}${isFinite(r.gust)?(" G"+r.gust):""}`;
    const windCell = `<td>${windTxt||"—"}</td>`;
    const visCell  = `<td>${isFinite(r.vis)?r.vis+" sm":"—"}</td>`;
    const altCell  = `<td>${isFinite(r.alt)?r.alt+" hPa":"—"}</td>`;
    const tdCell   = `<td>${isFinite(r.temp)?r.temp:"—"}/${isFinite(r.dewp)?r.dewp:"—"} °C</td>`;
    const rawCell  = `<td class="monospace">${(r.raw||"").replaceAll("<","&lt;")}</td>`;
    const btnCell  = `<td class="right"><button class="btn" data-raw>Copy</button></td>`;
    tr.innerHTML = timeCell+icaoCell+siteCell+catCell+windCell+visCell+altCell+tdCell+rawCell+btnCell;
    tr.querySelector("[data-raw]").onclick = ()=>{
      navigator.clipboard.writeText(r.raw||"");
      const b=tr.querySelector("[data-raw]"); b.textContent="Copied!"; setTimeout(()=>b.textContent="Copy",700);
    };
    if(lv.autoCopy.checked){
      tr.style.cursor="pointer";
      tr.onclick=(e)=>{ if(!(e.target && e.target.hasAttribute("data-raw"))) navigator.clipboard.writeText(r.raw||""); };
    }
    lv.body.appendChild(tr);
  }
}

/* download current filtered results as CSV */
function downloadLV(){
  // reconstruct from current table rows if desired; easier: re-run filter then dump
  const picks = parseICAOs(lv.icaos.value);
  const hours = +lv.hours.value || 6;
  const perStation = +lv.per.value || 5;
  const sortDir = lv.sort.value;
  const allowIFR = lv.chkIFRLIFR.checked, allowMVFR=lv.chkMVFR.checked, allowVFR=lv.chkVFR.checked;
  const now = Date.now(), cutoff = now - hours*3600*1000;

  let out=[], perCount={};
  const rows = allRows.filter(r=>r.observed_utc && r.icao);
  rows.sort((a,b)=> sortDir==="desc" ? (new Date(b.observed_utc)-new Date(a.observed_utc))
                                     : (new Date(a.observed_utc)-new Date(b.observed_utc)));
  for(const r of rows){
    const icao=(r.icao||"").toUpperCase(); if(!icao) continue;
    if(picks.length && !picks.includes(icao)) continue;
    const t=new Date(/[zZ]$/.test(r.observed_utc)?r.observed_utc:r.observed_utc+'Z').getTime();
    if(!(t>=cutoff)) continue;
    const cat=(r.flight_category||"").toUpperCase();
    const inCat = (allowIFR && (cat==="IFR"||cat==="LIFR")) || (allowMVFR && cat==="MVFR") || (allowVFR && cat==="VFR");
    if(!inCat) continue;
    const n=(perCount[icao]||0); if(n>=perStation) continue; perCount[icao]=n+1;

    out.push({
      observed_utc:r.observed_utc, icao, site:r.site||"", flight_category:cat,
      temp_c:r.temp_c, dewpoint_c:r.dewpoint_c, wind_dir_deg:r.wind_dir_deg, wind_kts:r.wind_kts, gust_kts:r.gust_kts,
      vis_sm:r.vis_sm, altimeter_hpa:r.altimeter_hpa, raw_text:r.raw_text||""
    });
  }
  const header = Object.keys(out[0]||{observed_utc:"",icao:"",site:"",flight_category:"",temp_c:"",dewpoint_c:"",wind_dir_deg:"",wind_kts:"",gust_kts:"",vis_sm:"",altimeter_hpa:"",raw_text:""});
  const csv = [header.join(","), ...out.map(o=>header.map(h=>String(o[h]??"").replace(/"/g,'""')).map(v=>/[,\"\n]/.test(v)?`"${v}"`:v).join(","))].join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="live_metars.csv"; a.click(); URL.revokeObjectURL(a.href);
}

/* ----------------------- Init UI ----------------------- */
$("#year").textContent=new Date().getFullYear();
document.querySelectorAll(".seg .seg-btn").forEach(b=>b.onclick=()=>renderTrend(b.dataset.region));
</script>
</body>
</html>

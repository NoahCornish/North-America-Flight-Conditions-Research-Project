<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>North America Flight Conditions — Research Dashboard (Test)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --ink:#0b2540; --muted:#62748a; --brand:#1a73e8; --accent:#2ecc71;
    --shadow:0 10px 26px rgba(0,0,0,.08); --ring:#d7dee8;
    --vfr:#2ecc71; --mvfr:#3498db; --ifr:#e74c3c; --lifr:#8e44ad;
    --chip:#eef2f7; --chip-ink:#334155;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0f172a; --ink:#e2e8f0; --muted:#93a4b8; --brand:#4f8dff; --accent:#37d084;
    --shadow:0 10px 30px rgba(0,0,0,.35); --ring:#19243d;
    --chip:#0b2540; --chip-ink:#cbd5e1;
    --vfr:#38d39f; --mvfr:#4ea8de; --ifr:#ef4444; --lifr:#a78bfa;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;box-shadow:var(--shadow)}
  .wrap{max-width:1200px;margin:0 auto;padding:.8rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-wrap:wrap}
  .brand{font-weight:800;font-size:1.05rem;letter-spacing:.2px;display:flex;align-items:center;gap:.5rem}
  .sub{opacity:.9;font-weight:600;font-size:.9rem}
  .bar{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}
  .pill{background:rgba(255,255,255,.15);padding:.25rem .55rem;border-radius:999px;font-size:.82rem}
  .toggle{appearance:none;width:44px;height:26px;background:#ffffff3b;border-radius:999px;position:relative;cursor:pointer;border:1px solid #ffffff55}
  .toggle:before{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.2s}
  .toggle:checked{background:#0000003b}
  .toggle:checked:before{transform:translateX(18px)}

  main{max-width:1200px;margin:1rem auto;padding:0 1rem 2rem;display:grid;gap:1rem}
  .card{background:var(--card);border-radius:18px;padding:1.1rem 1.2rem;box-shadow:var(--shadow);border:1px solid var(--ring)}
  .card h2{margin:.1rem 0 .8rem;font-size:1.15rem}
  .note{color:var(--muted);font-size:.92rem}
  .badge{padding:.25rem .6rem;border-radius:999px;color:#fff;font-weight:800;font-size:.8rem;box-shadow:var(--shadow)}
  .cat-VFR{background:var(--vfr)} .cat-MVFR{background:var(--mvfr)} .cat-IFR{background:var(--ifr)} .cat-LIFR{background:var(--lifr)}
  .chip{border-radius:999px;padding:.25rem .6rem;font-size:.78rem;font-weight:700;color:var(--chip-ink);background:var(--chip);border:1px solid var(--ring)}
  .chip.color{color:#fff;border:none}

  /* Overview pies */
  .legend{display:flex;flex-wrap:wrap;gap:.4rem}
  .legend .chip{cursor:pointer;transition:.12s transform}
  .legend .chip:hover{transform:translateY(-1px)}
  .pie-container{display:flex;flex-wrap:wrap;gap:1.25rem;justify-content:center}
  .pie-block{flex:1 1 240px;max-width:300px;text-align:center}
  .summary-box{display:flex;flex-wrap:wrap;gap:.35rem;justify-content:center;margin-top:.5rem}
  canvas.pie{max-width:220px !important;max-height:220px !important;margin:0 auto}

  /* Trend (bigger + region toggle) */
  .seg{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.5rem}
  .seg .seg-btn{border:1px solid var(--ring);background:var(--card);color:var(--ink);padding:.45rem .8rem;border-radius:10px;font-weight:700;cursor:pointer}
  .seg .seg-btn.active{background:var(--brand);color:#fff;border-color:transparent}
  #trendChart{width:100%;height:460px !important}

  /* IFR/LIFR Map */
  #mapCard .seg{margin-bottom:.6rem}
  #ifrlifrMap{height:460px;border-radius:14px;border:1px solid var(--ring);overflow:hidden}
  .map-note{margin-top:.4rem}

  /* Live METAR viewer (fixed footprint) */
  .controls{display:flex;gap:.6rem;flex-wrap:wrap;margin:.2rem 0 .6rem}
  select,input[type="number"],input[type="text"]{padding:.55rem .7rem;border:1px solid var(--ring);border-radius:10px;background:var(--card);color:var(--ink)}
  .chips{display:flex;gap:.5rem;flex-wrap:wrap}
  .btn{border:1px solid var(--ring);background:var(--card);color:var(--ink);padding:.5rem .85rem;border-radius:10px;font-weight:800;cursor:pointer}
  .btn.brand{background:var(--brand);color:#fff;border-color:transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .table-wrap{border:1px solid var(--ring);border-radius:12px;overflow:auto;max-height:360px;min-height:360px}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;font-size:.95rem}
  colgroup col.w-time{width:160px}
  colgroup col.w-icao{width:80px}
  colgroup col.w-site{width:200px}
  colgroup col.w-cat{width:84px}
  colgroup col.w-wind{width:120px}
  colgroup col.w-vis{width:80px}
  colgroup col.w-alt{width:90px}
  colgroup col.w-td{width:100px}
  colgroup col.w-raw{width:320px}
  colgroup col.w-act{width:96px}
  thead th{position:sticky;top:0;background:var(--card);z-index:1}
  th, td{padding:.6rem .7rem;border-bottom:1px solid var(--ring);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  tbody tr:last-child td{border-bottom:none}
  .right{text-align:right}
  .nowrap{white-space:nowrap}

  footer{padding:2rem 1rem;color:var(--muted);text-align:center;font-size:.9rem}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">✈️ North America Flight Conditions — <span class="sub">Research Dashboard</span></div>
    <div class="bar">
      <span class="pill" id="lastUpdated">Loading…</span>
      <span class="pill" id="metaLine">—</span>
      <label class="pill" style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
        <span>Dark</span><input id="themeToggle" class="toggle" type="checkbox" />
      </label>
    </div>
  </div>
</header>

<main>
  <!-- National overview pies -->
  <section class="card">
    <h2>National Overview</h2>
    <div class="legend" id="legendChips">
      <span class="chip color" data-cat="VFR" style="background:var(--vfr)">VFR</span>
      <span class="chip color" data-cat="MVFR" style="background:var(--mvfr)">MVFR</span>
      <span class="chip color" data-cat="IFR" style="background:var(--ifr)">IFR</span>
      <span class="chip color" data-cat="LIFR" style="background:var(--lifr)">LIFR</span>
    </div>
    <div class="pie-container" style="margin-top:.6rem">
      <div class="pie-block">
        <h3>Canada</h3>
        <canvas id="chartCA" class="pie"></canvas>
        <div id="summaryCA" class="summary-box"></div>
      </div>
      <div class="pie-block">
        <h3>USA</h3>
        <canvas id="chartUS" class="pie"></canvas>
        <div id="summaryUS" class="summary-box"></div>
      </div>
    </div>
  </section>

  <!-- Bigger Trend: % IFR+LIFR, MVFR, VFR (region toggle) -->
  <section class="card">
    <h2>24-Hour Trend — % by Category</h2>
    <div class="seg">
      <button class="seg-btn active" data-region="CA">Canada</button>
      <button class="seg-btn" data-region="US">USA</button>
    </div>
    <canvas id="trendChart"></canvas>
    <div class="note" style="margin-top:.4rem">
      Three series: <strong>IFR+LIFR</strong>, <strong>MVFR</strong>, <strong>VFR</strong> (share of observations per hour).
    </div>
  </section>

  <!-- IFR/LIFR Map -->
  <section id="mapCard" class="card">
    <h2>IFR / LIFR Map</h2>
    <div class="seg">
      <button class="seg-btn active" data-mapregion="CA">Canada</button>
      <button class="seg-btn" data-mapregion="US">USA</button>
    </div>
    <div id="ifrlifrMap"></div>
    <div id="mapNote" class="note map-note">Showing airports in IFR or LIFR from the latest observations.</div>
  </section>

  <!-- LIVE METAR VIEWER (latest only; fixed size; no layout shift) -->
  <section class="card">
    <h2>Live METAR Viewer (Latest Only)</h2>
    <div class="controls">
      <label style="flex:2;min-width:260px">ICAOs (comma/space-separated)
        <input id="lvIcaos" type="text" placeholder="CYTZ CYYZ KSEA KJFK" />
      </label>
      <div class="chips" style="align-items:center">
        <label class="chip"><input id="lvIFRLIFR" type="checkbox" checked style="transform:translateY(2px);margin-right:.35rem"> IFR+LIFR</label>
        <label class="chip"><input id="lvMVFR" type="checkbox" checked style="transform:translateY(2px);margin-right:.35rem"> MVFR</label>
        <label class="chip"><input id="lvVFR" type="checkbox" checked style="transform:translateY(2px);margin-right:.35rem"> VFR</label>
        <label class="chip"><input id="lvAutoCopy" type="checkbox" style="transform:translateY(2px);margin-right:.35rem"> Auto-copy RAW on row click</label>
      </div>
    </div>
    <div class="controls">
      <button id="lvRun" class="btn brand">Load Latest</button>
      <button id="lvReload" class="btn">Reload data</button>
      <span class="note" id="lvInfo">—</span>
    </div>
    <div class="table-wrap">
      <table id="lvTable">
        <colgroup>
          <col class="w-time"><col class="w-icao"><col class="w-site"><col class="w-cat"><col class="w-wind">
          <col class="w-vis"><col class="w-alt"><col class="w-td"><col class="w-raw"><col class="w-act">
        </colgroup>
        <thead>
          <tr>
            <th>Local Time</th>
            <th>ICAO</th>
            <th>Site</th>
            <th>Cat</th>
            <th>Wind</th>
            <th>Vis</th>
            <th>Alt</th>
            <th>Temp/Dew</th>
            <th>RAW</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="lvBody"></tbody>
      </table>
    </div>
  </section>

  <!-- About -->
  <section class="card">
    <h2>About This Research Project</h2>
    <p class="note">
      Live monitoring of <code>METAR</code> reports across Canada and the USA. National snapshots, a 24-hour category trend,
      an IFR/LIFR map, and a compact Live METAR viewer (latest only). Data updates ~every 5 minutes from <code>clean_metars.csv</code>.
    </p>
  </section>
</main>

<footer>
  © <span id="year"></span> North America Flight Conditions Research Project · Built with ❤️ for aviation & data science
</footer>

<script>
/* ----------------------- Config & helpers ----------------------- */
const CSV_METARS="https://raw.githubusercontent.com/NoahCornish/North-America-Flight-Conditions-Research-Project/refs/heads/main/Data/METARs/clean_metars.csv";

const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const cssVar=n=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
const COLORS={VFR:cssVar("--vfr"),MVFR:cssVar("--mvfr"),IFR:cssVar("--ifr"),LIFR:cssVar("--lifr")};
const toLocal=s=>{if(!s)return'—';if(!/[zZ]$/.test(s))s+='Z';return new Date(s).toLocaleString();};
const toTime=s=>{if(!s)return'—';if(!/[zZ]$/.test(s))s+='Z';const d=new Date(s);return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});}
function countryOf(icao){if(!icao)return null;const p=icao[0].toUpperCase();if(p==='C')return'CA';if(p==='K'||p==='P')return'US';return null;}
function asNum(v){const n=+v; return isFinite(n)?n:NaN;}

/* Theme */
const themeToggle=$("#themeToggle");
(()=>{const saved=localStorage.getItem("nafcrp_theme"); if(saved==="dark"){document.documentElement.setAttribute("data-theme","dark"); themeToggle.checked=true;}})();
themeToggle.addEventListener("change",()=>{
  if(themeToggle.checked){document.documentElement.setAttribute("data-theme","dark"); localStorage.setItem("nafcrp_theme","dark");}
  else{document.documentElement.removeAttribute("data-theme"); localStorage.setItem("nafcrp_theme","light");}
});

/* State */
let allRows=[], latestByIcao={}, newestISO=null, hiddenCats=new Set();
let charts={CA:null, US:null, trend:null};
let map, mapLayer, hasGeo=false;

/* ----------------------- Load data ----------------------- */
function loadMetars(cb){
  console.time("parse-metars");
  Papa.parse(CSV_METARS,{download:true, header:true, worker:true, complete:(res)=>{
    console.timeEnd("parse-metars");
    allRows = res.data.filter(r=>Object.values(r).some(v=>v)); // drop empties
    processLatest(allRows);
    $('#lastUpdated').textContent=newestISO?("Data as of "+toLocal(newestISO)):"No data";
    $("#metaLine").textContent = `${Object.keys(latestByIcao).length} airports · ${allRows.length.toLocaleString()} rows`;
    cb && cb();
  }});
}
loadMetars(()=>{
  renderOverview();
  renderTrend("CA");
  initMap();
  updateMap("CA");
});

/* ----------------------- Processing ----------------------- */
function getLatLonFromRow(r){
  const keys = Object.keys(r);
  let latKey = keys.find(k=>/^lat(itude)?(_deg)?$/i.test(k)) || keys.find(k=>/latitude/i.test(k));
  let lonKey = keys.find(k=>/^(lon(gitude)?|lng)(_deg)?$/i.test(k)) || keys.find(k=>/longitude/i.test(k));
  const lat = asNum(r[latKey]), lon = asNum(r[lonKey]);
  return {lat, lon};
}
function processLatest(rows){
  latestByIcao={}; newestISO=null; hasGeo=false;
  for(const r of rows){
    const icao=(r.icao||"").toUpperCase(); const obs=r.observed_utc;
    if(!icao||!obs) continue;
    const iso=/[zZ]$/.test(obs)?obs:obs+'Z';
    const t=new Date(iso);
    const prev=latestByIcao[icao];

    const {lat, lon} = getLatLonFromRow(r);
    if(isFinite(lat) && isFinite(lon)) hasGeo=true;

    if(!prev || t>new Date(prev._iso)){
      latestByIcao[icao]={
        _iso:iso, icao, site:r.site||"", cat:(r.flight_category||"").toUpperCase(),
        temp:asNum(r.temp_c), dewp:asNum(r.dewpoint_c), wdir:asNum(r.wind_dir_deg),
        wspd:asNum(r.wind_kts), gust:asNum(r.gust_kts), vis:asNum(r.vis_sm),
        alt:asNum(r.altimeter_hpa), raw:r.raw_text||"", lat, lon
      };
    }
    if(!newestISO || t>new Date(newestISO)) newestISO=iso;
  }
}

/* ----------------------- Overview pies ----------------------- */
function computeBreakdown(country){
  const counts={VFR:0,MVFR:0,IFR:0,LIFR:0};
  Object.values(latestByIcao).forEach(r=>{
    if(country && countryOf(r.icao)!==country) return;
    if(hiddenCats.has(r.cat)) return;
    if(counts[r.cat]!=null) counts[r.cat]++;
  });
  const total=Object.values(counts).reduce((a,b)=>a+b,0)||1;
  const pct=Object.fromEntries(Object.keys(counts).map(k=>[k, Math.round(counts[k]/total*100)]));
  return {counts,pct,total};
}
function renderSummaryBox(id,data){
  const box=$("#"+id); box.innerHTML="";
  Object.keys(data.counts).forEach(k=>{
    if(hiddenCats.has(k)) return;
    const el=document.createElement("span");
    el.className="chip color"; el.style.background=COLORS[k];
    el.textContent=`${k}: ${data.counts[k]} (${data.pct[k]}%)`;
    box.appendChild(el);
  });
}
function renderOverview(){
  const ctxCA=$("#chartCA"), ctxUS=$("#chartUS");
  const dataCA=computeBreakdown("CA"), dataUS=computeBreakdown("US");
  if(charts.CA)charts.CA.destroy(); if(charts.US)charts.US.destroy();

  const labels = Object.keys(dataCA.counts).filter(k=>!hiddenCats.has(k));
  const bg = labels.map(k=>COLORS[k]);
  const ds=(obj)=>labels.map(k=>obj.counts[k]||0);

  charts.CA=new Chart(ctxCA,{type:"pie",data:{labels,datasets:[{data:ds(dataCA),backgroundColor:bg}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false}});
  charts.US=new Chart(ctxUS,{type:"pie",data:{labels,datasets:[{data:ds(dataUS),backgroundColor:bg}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false}});
  renderSummaryBox("summaryCA",dataCA);
  renderSummaryBox("summaryUS",dataUS);

  // legend toggles
  $$("#legendChips .chip").forEach(ch=>{
    ch.onclick=()=>{
      const cat=ch.dataset.cat;
      if(hiddenCats.has(cat)){ hiddenCats.delete(cat); ch.style.opacity=1; }
      else { hiddenCats.add(cat); ch.style.opacity=.4; }
      renderOverview();
    };
  });
}

/* ----------------------- Trend (percent series) ----------------------- */
function hourKey(iso){ const d=new Date(/[zZ]$/.test(iso)?iso:iso+'Z'); d.setMinutes(0,0,0); return d.toISOString(); }
function computeTrend(region){
  const buckets=new Map(); // hour -> {total,vfr,mvfr,ifr,lifr}
  for(const r of allRows){
    const icao=(r.icao||"").toUpperCase(); if(!icao) continue;
    if(region && countryOf(icao)!==region) continue;
    const obs=r.observed_utc; if(!obs) continue;
    const key=hourKey(obs);
    const cat=(r.flight_category||"").toUpperCase();
    const obj=buckets.get(key)||{total:0,vfr:0,mvfr:0,ifr:0,lifr:0};
    obj.total++;
    if(cat==="VFR") obj.vfr++;
    else if(cat==="MVFR") obj.mvfr++;
    else if(cat==="IFR") obj.ifr++;
    else if(cat==="LIFR") obj.lifr++;
    buckets.set(key,obj);
  }
  const keys=[...buckets.keys()].sort((a,b)=>new Date(a)-new Date(b)).slice(-24);
  const labels=keys.map(k=>new Date(k).toLocaleTimeString([], {hour:'2-digit'}));
  const pct=(n,t)=>Math.round(100*(n/(t||1)));
  const series = keys.map(k=>buckets.get(k)).map(v=>({
    vfr: pct(v.vfr,v.total), mvfr: pct(v.mvfr,v.total), ifrlifr: pct(v.ifr+v.lifr,v.total)
  }));
  return {labels, vfr:series.map(s=>s.vfr), mvfr:series.map(s=>s.mvfr), ifrlifr:series.map(s=>s.ifrlifr)};
}
function renderTrend(region){
  const segBtns=$$(".seg .seg-btn");
  segBtns.forEach(b=>{
    if(b.dataset.region===region){ b.classList.add("active"); } 
    else if(b.dataset.region){ b.classList.remove("active"); }
  });
  const t=computeTrend(region);
  if(charts.trend) charts.trend.destroy();
  charts.trend=new Chart($("#trendChart"),{
    type:"line",
    data:{
      labels:t.labels,
      datasets:[
        {label:"IFR+LIFR", data:t.ifrlifr, borderWidth:3, tension:.25},
        {label:"MVFR", data:t.mvfr, borderWidth:3, tension:.25},
        {label:"VFR", data:t.vfr, borderWidth:3, tension:.25}
      ]
    },
    options:{scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+"%"}},x:{ticks:{maxRotation:0}}},plugins:{legend:{position:'bottom'}},maintainAspectRatio:false}
  });
}
document.querySelectorAll('.seg .seg-btn[data-region]').forEach(b=>b.addEventListener('click',()=>renderTrend(b.dataset.region)));

/* ----------------------- IFR/LIFR Map (Leaflet) ----------------------- */
function initMap(){
  if(map) return;
  map = L.map('ifrlifrMap',{zoomControl:true, attributionControl:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:10,minZoom:2,attribution:'© OpenStreetMap'}).addTo(map);
  mapLayer = L.layerGroup().addTo(map);
  fitMapTo("CA");
  setTimeout(()=>map.invalidateSize(), 150);
  document.querySelectorAll('.seg .seg-btn[data-mapregion]').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.seg .seg-btn[data-mapregion]').forEach(x=>x.classList.toggle('active', x===b));
      updateMap(b.dataset.mapregion);
    });
  });
}
function fitMapTo(region){
  if(region==="US"){ map.setView([39,-98], 4); }
  else { map.setView([56,-96], 4); } // Canada default
}
function updateMap(region){
  if(!map) return;
  mapLayer.clearLayers();
  fitMapTo(region);
  if(!hasGeo){
    $("#mapNote").textContent = "No latitude/longitude found in the dataset — map points unavailable.";
    return;
  } else {
    $("#mapNote").textContent = "Showing airports in IFR or LIFR from the latest observations.";
  }
  const rows = Object.values(latestByIcao).filter(r=>{
    return countryOf(r.icao)===region && (r.cat==="IFR"||r.cat==="LIFR") && isFinite(r.lat) && isFinite(r.lon);
  });
  rows.forEach(r=>{
    const color = r.cat==="LIFR" ? getComputedStyle(document.documentElement).getPropertyValue('--lifr').trim() : getComputedStyle(document.documentElement).getPropertyValue('--ifr').trim();
    const m = L.circleMarker([r.lat, r.lon],{radius:6, weight:1, color:"#00000040", fillColor:color, fillOpacity:.9});
    const txt = `<b>${r.site||r.icao}</b> — ${r.icao}<br/>Cat: <span style="color:#fff;background:${color};padding:2px 6px;border-radius:8px;font-weight:800">${r.cat}</span><br/>Obs: ${toLocal(r._iso)}<br/><code style="font-size:.85rem">${(r.raw||"").replaceAll("<","&lt;")}</code>`;
    m.bindPopup(txt);
    m.addTo(mapLayer);
  });
}

/* ----------------------- Live METAR Viewer (latest only) ----------------------- */
const lv = {
  icaos: $("#lvIcaos"),
  chkIFRLIFR: $("#lvIFRLIFR"),
  chkMVFR: $("#lvMVFR"),
  chkVFR: $("#lvVFR"),
  run: $("#lvRun"),
  reload: $("#lvReload"),
  autoCopy: $("#lvAutoCopy"),
  body: $("#lvBody"),
  info: $("#lvInfo")
};
(function initLV(){
  const saved = localStorage.getItem("lv_icaos");
  if(saved) lv.icaos.value = saved;
  if(!lv.icaos.value.trim()) lv.icaos.value = "CYTZ CYYZ CYOW KJFK KBOS";
  lv.run.onclick = runLV;
  lv.reload.onclick = ()=>loadMetars(()=>{ renderOverview(); renderTrend($(".seg .seg-btn.active[data-region]")?.dataset.region || "CA"); updateMap(document.querySelector('.seg .seg-btn.active[data-mapregion]')?.dataset.mapregion || "CA"); runLV(); });
})();
function parseICAOs(txt){
  return [...new Set(txt.toUpperCase().split(/[^A-Z0-9]+/).filter(x=>x.length>=3 && x.length<=5))].sort();
}
function runLV(){
  const picks = parseICAOs(lv.icaos.value);
  localStorage.setItem("lv_icaos", lv.icaos.value);
  const allowIFR = lv.chkIFRLIFR.checked, allowMVFR=lv.chkMVFR.checked, allowVFR=lv.chkVFR.checked;

  const out=[];
  for(const icao of picks){
    const r = latestByIcao[icao];
    if(!r) continue;
    const cat=r.cat;
    const inCat = (allowIFR && (cat==="IFR"||cat==="LIFR")) || (allowMVFR && cat==="MVFR") || (allowVFR && cat==="VFR");
    if(!inCat) continue;
    out.push(r);
  }
  renderLV(out);
  lv.info.textContent = `${out.length} stations · latest only`;
}
function renderLV(rows){
  lv.body.innerHTML="";
  for(const r of rows){
    const tr=document.createElement("tr");
    const windTxt  = `${isFinite(r.wdir)?r.wdir+"°":""} ${isFinite(r.wspd)?("@ "+r.wspd+" kt"):""}${isFinite(r.gust)?(" G"+r.gust):""}`;
    tr.innerHTML = `
      <td class="nowrap">${toLocal(r._iso)}</td>
      <td><b>${r.icao}</b></td>
      <td class="note">${(r.site||"")}</td>
      <td><span class="badge cat-${r.cat}">${r.cat}</span></td>
      <td>${windTxt||"—"}</td>
      <td>${isFinite(r.vis)?r.vis+" sm":"—"}</td>
      <td>${isFinite(r.alt)?r.alt+" hPa":"—"}</td>
      <td>${isFinite(r.temp)?r.temp:"—"}/${isFinite(r.dewp)?r.dewp:"—"} °C</td>
      <td class="monospace">${(r.raw||"").replaceAll("<","&lt;")}</td>
      <td class="right"><button class="btn" data-raw>Copy</button></td>
    `;
    const copyBtn = tr.querySelector("[data-raw]");
    copyBtn.onclick = (e)=>{ e.stopPropagation(); navigator.clipboard.writeText(r.raw||""); copyBtn.textContent="Copied!"; setTimeout(()=>copyBtn.textContent="Copy",700); };
    if(lv.autoCopy.checked){
      tr.style.cursor="pointer";
      tr.onclick=(e)=>{ if(!(e.target && e.target.hasAttribute("data-raw"))) navigator.clipboard.writeText(r.raw||""); };
    }
    lv.body.appendChild(tr);
  }
}

/* ----------------------- Init ----------------------- */
$("#year").textContent=new Date().getFullYear();

// Trend region buttons
document.querySelectorAll(".seg .seg-btn[data-region]").forEach(b=>b.addEventListener("click",()=>renderTrend(b.dataset.region)));
</script>
</body>
</html>
